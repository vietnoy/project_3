{
    "id": 62379,
    "kind": "MARKDOWN",
    "auditfirm_id": 34,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 1408,
    "title": "[FNG-11] All interest tokens can be stolen from the interest market",
    "content": "**Severity:** Critical\n\n**Path:** CErc721.sol:supplyInterestStoredInternal#L752-L763\n\n**Description:** The NFT underlying CToken, CErc721, uses a CErc20InterestMarket as tokens for both interest rewards for suppliers and interest payments for borrowers. In order to calculate the rewards for those supplies, it uses a supply index and `interestIndex` that is stored in the user’s snapshot such that past rewards aren’t counted (e.g. after claiming).\n\nThe difference between the new `supplyIndex` and `interestIndex` is then multiplied with the token balance of the user to calculate a supplier's earned interest. \n\nHowever, this process does not take transfers into account and this can be used to create arbitrary interest rewards. More specifically, when the shares (CTokens) are transferred to another user, the balance increases, but it does not set the `interestIndex` for the receiving user (e.g. by forcing a claim in a `_beforeTokenTransfer` hook).\n\nIn other words, a balance increase occurs and thus the receiving user can claim rewards over the new balance without actually having held this balance over the reward period.\n\nFor example:\n\n1. User A supplies 1 NFT and mints 100 CTokens.\n\n2. User B-Z call a reward claim to set their `interestIndex` (otherwise a division by 0 would occur).\n\n3. After some time, the `supplyIndex` has increased.\n\n4. User A can now claim rewards and transfer the balance of 100 CTokens to user B.\n\n5. User B can now claim the same rewards over the new balance and then transfer the balance to user C.\n\n6. Repeat step 5 for all users.\n\nBy having some built up interest from the index and enough accounts (e.g. using an exploit contract) an attacker could instantly and completely drain the interest market of all its underlying tokens.\n```\n    function supplyInterestStoredInternal(address account) internal view returns (uint) {\n        Exp memory exchangeRate = Exp({mantissa: exchangeRateStored()});\n        uint supplyBalance = mul_ScalarTruncate(exchangeRate, accountTokens[account]);\n\n        if (supplyBalance == 0) {\n            return 0;\n        }\n\n        SupplyInterestSnapshot storage supplyInterestSnapshot = supplyInterest[account];\n        uint newInterestAccrued = (supplyBalance * supplyIndex / supplyInterestSnapshot.interestIndex) - supplyBalance;\n        return supplyInterestSnapshot.interestAccrued + newInterestAccrued;\n    }\n```\n\n**Remediation:**  The CErc721 contract should override the `_beforeTokenTransfer` hook and force a claiming of interest rewards for both the sender and receiver.\n\n**Status:**  Fixed\n\n\n- - -",
    "summary": "\nThis bug report describes a critical issue in the CErc721 contract, which is used for NFTs. The contract uses a CErc20InterestMarket for interest rewards for suppliers and payments for borrowers. However, the process for calculating interest rewards does not take transfers into account, allowing for arbitrary interest rewards to be created. This means an attacker could drain all the underlying tokens from the interest market. The suggested fix is to override the `_beforeTokenTransfer` hook and force a claiming of interest rewards for both the sender and receiver. This issue has been fixed.",
    "report_date": "2023-11-06T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/solodit/solodit_content/blob/main/reports/Hexens/2023-11-06-Fungify.md",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "fng-11-all-interest-tokens-can-be-stolen-from-the-interest-market-hexens-none-fungify-markdown",
    "firm_name": "Hexens",
    "firm_logo_square": "Hexens_square.png",
    "protocol_name": "Fungify",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Hexens"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Hexens",
        "logo_square": "Hexens_square.png"
    },
    "protocols_protocol": {
        "name": "Fungify",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}