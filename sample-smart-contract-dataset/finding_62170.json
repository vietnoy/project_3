{
    "id": 62170,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "MEDIUM",
    "finders_count": 4,
    "protocol_id": 3130,
    "title": "M-8: Restaker rewards on zero coverage agent will be stolen by subsequent restaker interest realization",
    "content": "\nSource: https://github.com/sherlock-audit/2025-07-cap-judging/issues/467 \n\n## Found by \nUddercover, attacker\\_code, montecristo, silver\\_eth\n\n### Summary\n\nLender contract will transfer realized restaker interest to Delegation contract. Delegation contract is supposed to transfer the received amount to network middleware and delegate rewards distribution.\n\nHowever, in an edge case where agent's coverage is 0, Delegation contract skips such flow. Thus, received amount will be stuck in Delegation contract until the next restaker interest realization.\n\nIn this case, subsequent restaker interest realization will sweep stuck amount and target restakers receive more rewards than deserved.\n\n### Root Cause\n\nRoot cause lies in the fact that Delegation contract skips network reward distribution if agent's current coverage is 0:\n\n[File: cap-contracts/contracts/delegation/Delegation.sol](https://github.com/sherlock-audit/2025-07-cap/blob/2bd34fa369d36af8ecc377090d3292ea74ccc669/cap-contracts/contracts/delegation/Delegation.sol#L55-L64)\n```solidity\n55: function distributeRewards(address _agent, address _asset) external {\n56:         DelegationStorage storage $ = getDelegationStorage();\n57:         uint256 _amount = IERC20(_asset).balanceOf(address(this));\n58: \n59:         uint256 totalCoverage = coverage(_agent);\n60:@>       if (totalCoverage == 0) return;\n61: \n62:         address network = $.agentData[_agent].network;\n63:         IERC20(_asset).safeTransfer(network, _amount);\n64:         ISymbioticNetworkMiddleware(network).distributeRewards(_agent, _asset);\n```\n\nHowever, Delegation contract already has received restaker interest from Lender contract:\n\n[File: cap-contracts/contracts/lendingPool/libraries/BorrowLogic.sol](https://github.com/sherlock-audit/2025-07-cap/blob/2bd34fa369d36af8ecc377090d3292ea74ccc669/cap-contracts/contracts/lendingPool/libraries/BorrowLogic.sol#L217-L218)\n```solidity\n217:@>        IVault(reserve.vault).borrow(_asset, realizedInterest, $.delegation);\n218:@>       IDelegation($.delegation).distributeRewards(_agent, _asset);\n```\n\nThus, restaker interest will be stuck at Delegation contract.\n\nDue to L57, next restaker interest realization will sweep this amount to another subnetwork.\n\n### Internal Pre-conditions\n\n1. Debt repay or liquidation happens on zero-coverage agent's position.\n\nZero coverage can happen in one of the following scenarios:\n\n- All restaked amount are scheduled to be withdrawn\n- Agent's network limit is set to 0\n- Protocol team repays on bad debt position. More specifically, previous liquidation already set agent's delegation to zero.\n\n### External Pre-conditions\n\nn/a\n\n### Attack Path\n\nn/a\n\n### Impact\n\nSince `realizeRestakerInterest` is public, restaker rewards can be stolen by any interested party (e.g. agent or restaker)\n\n### PoC\n\n_No response_\n\n### Mitigation\n\nDon't send restaker interest to Delegation contract if coverage is 0.\n\nInstead, send it to FeeAuction contract so that the interest is distributed among scUSD holders.\n\nAlternatively, one can fix `maxRestakerRealization` so that realized interest amount is 0 when agent's coverage is 0.\n\n",
    "summary": "\nThis bug report discusses an issue found in the Lender contract, where the realized restaker interest is not properly transferred to the Delegation contract. This results in the amount being stuck in the Delegation contract until the next restaker interest realization, causing subsequent restaker interest realizations to distribute more rewards than intended. The root cause of this issue is that the Delegation contract skips network reward distribution if the agent's current coverage is 0. This can happen in certain scenarios such as when all restaked amount is scheduled to be withdrawn or when the protocol team repays on a bad debt position. The impact of this bug is that anyone can potentially steal restaker rewards, and the suggested mitigation is to not send restaker interest to the Delegation contract if coverage is 0 and instead distribute it among scUSD holders. ",
    "report_date": "2025-07-24T15:00:00.000Z",
    "contest_prize_txt": "126000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/990",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-07-cap-judging/issues/467",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "990",
    "slug": "m-8-restaker-rewards-on-zero-coverage-agent-will-be-stolen-by-subsequent-restaker-interest-realization-sherlock-cap-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "Cap",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "attacker\\_code"
            }
        },
        {
            "wardens_warden": {
                "handle": "montecristo"
            }
        },
        {
            "wardens_warden": {
                "handle": "Uddercover"
            }
        },
        {
            "wardens_warden": {
                "handle": "silver\\_eth"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "Cap",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}