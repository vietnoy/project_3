{
    "id": 62812,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 3398,
    "title": "H-5: `RangePool::adjustToTick()` desyncs when `nextTick == tick` leading to stolen fees",
    "content": "\nSource: https://github.com/sherlock-audit/2025-09-bmx-deli-swap-judging/issues/178 \n\n## Found by \n0x73696d616f\n\n### Summary\n\n`RangePool::adjustToTick()` breaks when the `nextTick` equals the current tick:\n```solidity\nfunction adjustToTick(State storage self, int24 tickSpacing, int24 tick, address[] memory tokens) internal {\n    int24 currentTick = self.tick;\n    int128 liquidityChange = 0;\n    bool lte = tick <= currentTick;\n\n    if (lte) {\n        while (tick < currentTick) {\n            (int24 nextTick, bool initialized) =\n                self.tickBitmap.nextInitializedTickWithinOneWord(currentTick, tickSpacing, true);\n\n            if (nextTick <= tick) { //@audit here\n                break;\n            }\n    ...\n```\nHowever, this will desync with the Uniswap pool whenever the sqrtPrice reaches the next tick. \n\nFor example, consider that a swap moved the price to tick 60, tick spacing is 60, and there is an initialized tick at 60. Looking at the Uniswap pool [code](https://github.com/Uniswap/v4-core/blob/main/src/libraries/Pool.sol#L409-L413), it will cross the tick, and positions from ticks 0 to 60 will now accrue fees, not 60 to 120.\n\nBut, this won't happen in the DailyEpochGauge nor IncentiveGauge. These pools will be [poked](https://github.com/sherlock-audit/2025-09-bmx-deli-swap/blob/main/deli-swap-contracts/src/DeliHook.sol#L292-L293) after the swap, so the tick at 60 has been crossed in the Uniswap pool, but in the `RangePool::adjustToTick()` logic, it won't [cross](https://github.com/sherlock-audit/2025-09-bmx-deli-swap/blob/main/deli-swap-contracts/src/libraries/RangePool.sol#L174-L176) the tick, as the nextTick is 60, and so is the tick, which breaks and doesn't flip the tick nor update liquidity.\n\nAs a result, the following happens:\n1. Positions with tick lower at 60 should be out of range (real Uniswap pool tick becomes 59 when the sqrtPrice reaches 60), but in the DailyEpochGauge and IncentiveGauge they will in reality be in range.\n2. Thus, an attacker may exploit this to add liquidity to the Uniswap pool at ticks 60 to 120, out of range, where regular users and bots won't add liquidity because it is out of range. The attacker will get away with most of the fees.\n3. An attacker can force this to happen by specifying the sqrtLimit in the swap to be exactly the next initialized tick, and add liquidity to the out of range position to steal fees.\n\n### Root Cause\n\nIn `RangePool.sol:174`, the [break condition](https://github.com/sherlock-audit/2025-09-bmx-deli-swap/blob/main/deli-swap-contracts/src/libraries/RangePool.sol#L174-L176) is incorrect and makes the pool desync.\n\n### Internal Pre-conditions\n\nNone.\n\n### External Pre-conditions\n\nNone.\n\n### Attack Path\n\n1. Attacker swaps in `PoolManager.swap()`, setting the sqrtPrice to the next initialized tick. The Uniswap pool will cross the tick, but the DailyEpochGauge/IncentiveGauge won't.\n2. Attacker adds liquidity to the position out of range in the Uniswap pool, stealing the fees from honest users that placed liquidity in the in range position.\n\n### Impact\n\n100% of the fees are stolen by the out of range positions.\n\n### PoC\n\nSee above.\n\n### Mitigation\n\n_No response_\n\n## Discussion\n\n**sherlock-admin2**\n\nThe protocol team fixed this issue in the following PRs/commits:\nhttps://github.com/morphex-labs/deli-swap-contracts/pull/19\n\n\n\n\n",
    "summary": "\nThis bug report is about a problem found in the DeliSwap contract code. The issue was discovered by a user called 0x73696d616f and it involves the function \"adjustToTick()\" in the RangePool contract. This function breaks when the current tick is equal to the next tick, causing the contract to desync with the Uniswap pool. This can lead to an attacker exploiting the contract and stealing fees from honest users. The root cause of the issue is an incorrect break condition in the code. The impact of this bug is that 100% of the fees can be stolen by the attacker. The protocol team has fixed this issue in their code, but there has been no response from them in this bug report.",
    "report_date": "2025-09-16T15:00:00.000Z",
    "contest_prize_txt": "47000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1154",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-09-bmx-deli-swap-judging/issues/178",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1154",
    "slug": "h-5-rangepooladjusttotick-desyncs-when-nexttick-tick-leading-to-stolen-fees-sherlock-bmx-deli-swap-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "BMX Deli Swap",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "0x73696d616f"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "BMX Deli Swap",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}