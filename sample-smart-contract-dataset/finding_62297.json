{
    "id": 62297,
    "kind": "PDF",
    "auditfirm_id": 6,
    "impact": "MEDIUM",
    "finders_count": 3,
    "protocol_id": 3396,
    "title": "Pi interest rate model is manipulatable due to current balances used",
    "content": "## Security Analysis Report\n\n### Severity\n**Medium Risk**\n\n### Context\n`BasePiReserveRateStrategy.sol#L253`\n\n### Description\nThe interest rate is controlled by the utilization factor:\n\n```solidity\nfunction _calculateInterestRates(\n    address,\n    uint256 availableLiquidity,\n    uint256 totalVariableDebt,\n    uint256 reserveFactor\n) internal returns (uint256, uint256, uint256) {\n    uint256 utilizationRate = totalVariableDebt == 0\n        ? 0\n        : totalVariableDebt.rayDiv(availableLiquidity + totalVariableDebt);\n    \n    // If no borrowers we reset the strategy\n    if (utilizationRate == 0) {\n        _errI = 0;\n        _lastTimestamp = block.timestamp;\n        return (0, 0, 0);\n    }\n    \n    // PID state update\n    int256 err = getNormalizedError(utilizationRate);\n    _errI += int256(_ki).rayMulInt(err * int256(block.timestamp - _lastTimestamp)); // <<<\n    if (_errI < _maxErrIAmp) _errI = _maxErrIAmp; // Limit _errI negative accumulation.\n    _lastTimestamp = block.timestamp;\n    \n    int256 controllerErr = getControllerError(err);\n    uint256 currentVariableBorrowRate = transferFunction(controllerErr);\n    uint256 currentLiquidityRate = getLiquidityRate(currentVariableBorrowRate, utilizationRate, reserveFactor);\n    \n    emit PidLog(\n        utilizationRate, currentLiquidityRate, currentVariableBorrowRate, err, controllerErr\n    );\n    \n    return (currentLiquidityRate, currentVariableBorrowRate, utilizationRate);\n}\n```\n\nUnfortunately, since instant values for available liquidity and debt are used (and `_errI` is only updated once per block), it is possible for participants to manipulate the direction of the rate to their advantage by using a flash loan or a borrow:\n\n- **Borrower side:** The borrower can first use a flash loan to deposit into the pool, then withdraw, and finally borrow (`_errI` won't be updated for the last two operations).\n- **Lender side:** The lender can first borrow, increasing `_errI`, and then repay the same amount (repaying won't change `_errI` in the same block).\n\n### Recommendation\nUse previous `availableLiquidity` and `totalVariableDebt` to update `_errI`.\n\n### Acknowledgments\n- Astera: Acknowledged.\n- Spearbit: Acknowledged.",
    "summary": "\nThis bug report discusses a medium risk issue in the code of `BasePiReserveRateStrategy.sol#L253`. The interest rate calculation is vulnerable to manipulation by participants using flash loans or borrowing and repaying in the same block. The recommendation is to use previous values for `availableLiquidity` and `totalVariableDebt` to update the affected variable. The issue has been acknowledged by Astera and Spearbit.",
    "report_date": "2025-08-29T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Astera-Spearbit-Security-Review-December-2024.pdf",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Astera-Spearbit-Security-Review-December-2024.pdf",
    "github_link": "",
    "pdf_link": "https://solodit-bucket.s3.amazonaws.com/storage/reports/spearbit/Astera-Spearbit-Security-Review-December-2024.pdf",
    "pdf_page_from": 31,
    "contest_id": "",
    "slug": "pi-interest-rate-model-is-manipulatable-due-to-current-balances-used-spearbit-none-astera-pdf",
    "firm_name": "Spearbit",
    "firm_logo_square": "spearbit_square.png",
    "protocol_name": "Astera",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Saw-mon and Natalie"
            }
        },
        {
            "wardens_warden": {
                "handle": "Cergyk"
            }
        },
        {
            "wardens_warden": {
                "handle": "Jonatas Martins"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Spearbit",
        "logo_square": "spearbit_square.png"
    },
    "protocols_protocol": {
        "name": "Astera",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}