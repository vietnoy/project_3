{
    "id": 62073,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "MEDIUM",
    "finders_count": 1,
    "protocol_id": 2159,
    "title": "[M-10] Division before multiplication may cause division by zero DOS during low backstop supply",
    "content": "\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/auctions/backstop_interest_auction.rs# L76-L84>\n\n### Finding description and impact\n\nDivision before multiplication and unchecked oracle decimals may cause division by zero DOS during low backstop supply.\n\n### Proof of Concept\n\nWhen calculating `backstop_token_to_base`, division before multiplication is performed when deriving `backstop_value_base`. Currently, `oracle_scalar` is intended to prevent excessive precision loss in `backstop_value_base` calculation.\n\nThere are two vulnerabilities here:\n\n1. Pool deployment is permissionless and `oracle_scalar` is based on unchecked pool’s [constructor parameters](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/contract.rs# L339), i.e. custom oracle implementation [`oracle_client.decimals()`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/pool.rs# L107). There is no check that the oracle’s decimal is greater than 7. When `oracle_scalar` is less than `10e7`, `backstop_value_base` will round down and lose precision.\n```\n\npub fn execute_initialize(\n    e: &Env,\n    admin: &Address,\n    name: &String,\n    oracle: &Address,\n    bstop_rate: &u32,\n    max_positions: &u32,\n    min_collateral: &i128,\n    backstop_address: &Address,\n    blnd_id: &Address,\n) {\n    let pool_config = PoolConfig {\n|>      oracle: oracle.clone(), //@audit no check on oracle decimal precisions.\n        min_collateral: *min_collateral,\n        bstop_rate: *bstop_rate,\n        status: 6,\n        max_positions: *max_positions,\n    };\n```\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/config.rs# L28>\n\n2. Division before multiplication: `backstop_value_base` performs integer division first before multiplication in `backstop_token_to_base`.\n```\n\n    // get value of backstop_token (BLND-USDC LP token) to base\n    let pool_backstop_data = backstop_client.pool_data(&e.current_contract_address());\n    //@audit (usdc * oracle_scalar / scalar_7) perform division first before multiplication in `backstop_token_to_base`\n|>  let backstop_value_base = pool_backstop_data\n        .usdc\n        .fixed_mul_floor(e, &oracle_scalar, &SCALAR_7) // adjust for oracle scalar\n        * 5; // Since the backstop LP token is an 80/20 split of USDC/BLND, we multiply by 5 to get the value of the BLND portion\n    let backstop_token_to_base =\n        backstop_value_base.fixed_div_floor(e, &pool_backstop_data.tokens, &SCALAR_7);\n\n    // determine lot amount of backstop tokens needed to safely cover bad debt, or post\n    // all backstop tokens if there isn't enough to cover the bad debt\n    let mut lot_amount = debt_value\n        .fixed_mul_floor(e, &1_2000000, &SCALAR_7)\n        .fixed_div_floor(e, &backstop_token_to_base, &SCALAR_7);\n```\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/auctions/bad_debt_auction.rs# L75-L81>\n\nThe above may cause `backstop_token_to_base` round down to zero when backstop is low in supply, resulting in division by zero panic in `create_interest_auction_data` and `create_bad_debt_auction_data`.\nBackstop supply(`pool_backstop_data.tokens`) can be low when lending pool is new or due to large backstop depositor withdrawals.\n\n### POC\n\nSuppose `pool_backstop_data.usdc = 0_0050000`, `pool_backstop_data.tokens = 10_0000000`, `oracle_scalar = 100`.\n\n`backstop_value_base = (pool_backstop_data.usdc * oracle_scalar / SCALAR_7) * 5`\n```\n\n                    = (50000 * 100 / 1e7) * 5 -> 0\n```\n\n`backstop_token_to_base = backstop_value_base * SCALAR_7 / pool_backstop_data.tokens`\n```\n\n                       = 0\n```\n\n**Case 1: bad debt auction:**\n`lot_amount` = `debt_value * 1.2 * SCALAR_7 / backstop_token_to_base` -> division by zero\n\n**Case 2: interest auction:**\n`bit_amount` = `interest_value * 1.2 * SCALAR_7 / backstop_token_to_base` -> division by zero\n\nAs seen above, both bad debt auction and interest auction flow can be DOSsed when backstop supply is critically low.\n\n### Impact\n\nWhen backstop token supply for a pool is critically low (or zero), the pool can be extremely unhealthy and risky. The pool needs more backstop deposits through interest auctions where existing backstop credits accumulated in the pool’s reserves can be auctioned in exchange for more backstop tokens to offset bad debts.\n\nHowever, from the POC we see that interest auction can be DOSsed and the pool cannot attract more backstop tokens when it needs them the most.\n\n### Recommended mitigation steps\n\nIn pool’s constructor → [`require_valid_pool_config`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/config.rs# L176), consider enforcing checks that the oracle decimal is no less than 7.\n\nMay also consider fetching the comet pool’s usdc and total supply to derive `backstop_token_to_base` directly without relying on the intermediate `pool_backstop_data.tokens`.\n\n**markus\\_pl10 (Script3) confirmed**\n\n**[mootz12 (Script3) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42?commentParent=jMGTurSFG4h):**\n\n> Validated this is an issue. Documentation likely needs to be added to ensure extremely low decimal oracles aren’t used.\n>\n> Regardless, an interest auction likely should be able to be created for an empty backstop, even if this situation is unlikely (can’t borrow funds unless your past backstop threshold).\n>\n> No risk to backstop credit, as if more tokens enter the backstop, the credit is safely tracked and the interest auction can be created later. This is incredibly likely as interest auctions need at least `$200` to get kicked off, and this example shows `$0.05` in total backstop deposits.\n\n**[LSDan (judge) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42?commentParent=jMGTurSFG4h&commentChild=ypRt6c4mdNw):**\n\n> This holds as a medium for me. The functionality of the protocol could be impacted enough that mitigations are required.\n\n**[mootz12 (Script3) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42?commentParent=zCkW6MWcSDY):**\n\n> Fixed [here](https://github.com/blend-capital/blend-contracts-v2/pull/49/commits/f0296cf283ede61707c34c6af6508320cb6de3ca) - token price returned from backstop, no longer depends on pool backstop state.\n\n**[Testerbot (warden) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42?commentParent=Bbj5QUfYLcA):**\n\n> I would like to address the classification of this issue, as I believe it may have been incorrectly assessed.\n>\n> The issue in question was marked as medium severity. However, I would like to provide my reasoning for reconsideration:\n>\n> The core of the reported issue lies in the following formula:\n>\n> \n```\n\n> backstop_value_base = (pool_backstop_data.usdc * oracle_scalar / SCALAR_7)\n> \n```\n\n>\n> If the product of `pool_backstop_data.usdc * oracle_scalar` is less than `10e7`, then `backstop_value_base` will round down to zero, leading to a division by zero panic later in the code.\n>\n> ### Likelihood Analysis\n>\n> The condition to trigger this issue is `pool_backstop_data.usdc * oracle_scalar < 10e7`.\n>\n> In Soroban, tokens typically have 7 decimal places, which applies to USDC. Therefore, the first condition to meet is for `pool_backstop_data.usdc` to be less than `1 USDC` (10e7). This means that at least 1 USDC will prevent this issue from occurring.\n>\n> If we consider `0.1 USDC` (10e6), the oracle price would need to have at most 1 decimal (10). For `0.01 USDC` (10e5), the oracle price would need at most 2 decimals (100), and so on.\n>\n> Consequently, it is unlikely that such a small amount of USDC would be deposited in the backstop, and having oracle prices with such limited decimal places simultaneously is even less probable. From the currently deployed oracle providers on Stellar, I have not found any prices with fewer than 7 decimals:\n>\n> [Current oracle providers](https://developers.stellar.org/docs/data/oracles/oracle-providers).\n> [Reflector contract](https://stellar.expert/explorer/public/contract/CALI2BYU2JE6WVRUFYTS6MSBNEHGJ35P4AVCZYF3B6QOE3QKOB2PLE6M?durability=persistent). Reflector set prices with 7 decimals.\n>\n> ### Impact Analysis\n>\n> Even in the unlikely event that this situation occurs, the impact does not warrant a medium severity classification. The report describes the following impact:\n>\n> > The above may cause `backstop_token_to_base` round down to zero when backstop is low in supply, resulting in division by zero panic in `create_interest_auction_data` and `create_bad_debt_auction_data`.\n>\n> The division by zero will prevent the creation of bad debt and interest auctions. Some facts about this:\n>\n> * These functions are not core components of the lending protocol that put user funds at risk.\n> * The denial of service (DoS) regarding the interest auction is temporary and easily remedied; an admin or any user can simply make a deposit to the backstop contract, which is not affected by this issue.\n> * This situation is no different to a pool without backstop deposits, where it is normal not to have bad debt or interest auctions (as there would be no one to cover bad debt or claim interest).\n>\n> In conclusion, we are dealing with a scenario that is very unlikely to occur, and the worst-case impact is merely a temporary DoS.\n\n**[rscodes (warden) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42?commentParent=Bbj5QUfYLcA&commentChild=P5nRdae4YDU):**\n\n> In addition to Testerbot’s comment, I would like to add that according to the competition page token table: `Low decimals ( < 6) | Out of scope`.\n>\n> I understand that the above submission is about oracle decimal. However, `oracle decimal => token decimal`. If low decimal tokens are not used (as oos) then it doesn’t make sense to use a low decimal oracle, since the oracle is supposed to reflect the price of the token.\n\n**[LSDan (judge) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42?commentParent=Bbj5QUfYLcA&commentChild=6NsiiWyRB76):**\n\n> Ruling stands. This is 6, not `< 6`. Medium still holds for me.\n\n**[Blend mitigated](https://github.com/code-423n4/2025-04-blend-mitigation?tab=readme-ov-file# mitigation-of-high--medium-severity-issues):**\n\n> [Commit f0296cf](https://github.com/blend-capital/blend-contracts-v2/pull/49/commits/f0296cf283ede61707c34c6af6508320cb6de3ca) to make `lp token` valuation pool independent for auction creation.\n\n**Status:** Mitigation confirmed. Full details in reports from [0xAlix2](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-19), [Testerbot](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-72), [0x007](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-52), [oakcobalt](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-26) and [rscodes](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-85).\n\n---\n\n",
    "summary": "\nThis bug report discusses a potential issue in the code for the Blend lending protocol. The issue involves a division before multiplication calculation and unchecked oracle decimal values, which could result in a division by zero error during low backstop supply. This could potentially cause a denial of service (DOS) attack on the protocol.\n\nThe proof of concept provided shows how this issue could occur and the impact it could have on the protocol. It is recommended to add checks for the oracle decimal value to prevent this issue from occurring. The mitigation steps suggested include enforcing checks on the oracle decimal value and fetching data directly from the comet pool to avoid relying on intermediate values.\n\nThe impact of this issue is that the pool may become unhealthy and risky if backstop deposits are critically low. This could make it difficult to attract more backstop tokens when they are needed the most. The severity of this issue has been debated, with some suggesting it is a medium severity while others believe it is a low severity issue. The Blend team has confirmed that they have mitigated this issue by making the LP token valuation pool independent for auction creation. ",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "125000",
    "contest_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "sponsor_name": "Blend",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "github_link": "https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-42",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "492",
    "slug": "m-10-division-before-multiplication-may-cause-division-by-zero-dos-during-low-backstop-supply-code4rena-blend-blend-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Blend",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "oakcobalt"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Blend",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}