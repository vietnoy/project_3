{
    "id": 62494,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "MEDIUM",
    "finders_count": 21,
    "protocol_id": 3104,
    "title": "M-2: Incorrect `tokensClaimed` calculation in `EthenaCooldownHolder::_finalizeCooldown()` blocks withdrawals",
    "content": "\nSource: https://github.com/sherlock-audit/2025-06-notional-exponent-judging/issues/263 \n\n## Found by \n0xDeoGratias, 0xc0ffEE, 0xpiken, 0xzey, Atharv, Cybrid, KungFuPanda, Ragnarok, Schnilch, X0sauce, almurhasan, boredpukar, bretzel, elolpuer, hgrano, holtzzx, kangaroo, patitonar, pseudoArtist, touristS, xiaoming90\n\n### Summary\n\nUsers are unable to withdraw tokens from the `EthenaWithdrawRequestManager` contract when initiating a withdrawal while `sUSDe.cooldownDuration()` is set to `0`, due to flawed logic in the `EthenaCooldownHolder::_finalizeCooldown()` function.\n\n### Root Cause\n\nWhen a user initiates a withdrawal request via the `EthenaWithdrawRequestManager` contract, it internally calls `EthenaCooldownHolder::_startCooldown()`:\n\n[EthenaCooldownHolder::_startCooldown()](https://github.com/sherlock-audit/2025-06-notional-exponent/blob/82c87105f6b32bb362d7523356f235b5b07509f9/notional-v4/src/withdraws/Ethena.sol#L16) function:\n```solidity\nfunction _startCooldown(uint256 cooldownBalance) internal override {\n      uint24 duration = sUSDe.cooldownDuration();\n      if (duration == 0) {\n          // If the cooldown duration is set to zero, can redeem immediately\n=>        sUSDe.redeem(cooldownBalance, address(this), address(this));\n      } else {\n         ...\n      }\n  }\n```\n\nIf `cooldownDuration` is `0`, the `sUSDe` is immediately redeemed for `USDe`, and the `USDe` tokens are transferred to the `EthenaCooldownHolder` contract. Later, when the user finalizes their withdrawal, `EthenaCooldownHolder::_finalizeCooldown()` is called:\n\n[EthenaCooldownHolder::_finalizeCooldown()](https://github.com/sherlock-audit/2025-06-notional-exponent/blob/82c87105f6b32bb362d7523356f235b5b07509f9/notional-v4/src/withdraws/Ethena.sol#L30) function:\n```solidity\nfunction _finalizeCooldown() internal override returns (uint256 tokensClaimed, bool finalized) {\n    uint24 duration = sUSDe.cooldownDuration();\n    IsUSDe.UserCooldown memory userCooldown = sUSDe.cooldowns(address(this));\n\n    if (block.timestamp < userCooldown.cooldownEnd && 0 < duration) {\n        // Cooldown has not completed, return a false for finalized\n        return (0, false);\n    }\n\n    uint256 balanceBefore = USDe.balanceOf(address(this));\n    if (0 < userCooldown.cooldownEnd) sUSDe.unstake(address(this));\n    uint256 balanceAfter = USDe.balanceOf(address(this));\n\n=>  tokensClaimed = balanceAfter - balanceBefore;\n    USDe.transfer(manager, tokensClaimed);\n    finalized = true;\n}\n```\n\nSince the `USDe` has already been withdrawn to the holder contract at the time the withdrawal request is initiated, `balanceBefore` is equal to `balanceAfter`. As a result, `tokensClaimed` is incorrectly calculated as 0, preventing users from claiming any tokens from their withdrawal request.\n\n### Impact\n\nUsers are unable to claim any tokens from their withdrawal requests if they were initiated when `sUSDe.cooldownDuration()` was `0`.\n\n### Mitigation\n\nTrack the balance change when initiating a withdrawal request while `sUSDe.cooldownDuration()` is set to 0, and use this state to determine the balance change when finalizing the withdrawal request.\n\n## Discussion\n\n**sherlock-admin2**\n\nThe protocol team fixed this issue in the following PRs/commits:\nhttps://github.com/notional-finance/notional-v4/pull/19\n\n\n\n\n",
    "summary": "\nThe bug report states that users are unable to withdraw tokens from the `EthenaWithdrawRequestManager` contract when the `sUSDe.cooldownDuration()` is set to `0`. This is due to a flaw in the `EthenaCooldownHolder::_finalizeCooldown()` function. When a user initiates a withdrawal request, the `EthenaCooldownHolder::_startCooldown()` function is called, which redeems the `sUSDe` tokens for `USDe` and transfers them to the `EthenaCooldownHolder` contract. However, when the user finalizes their withdrawal, the `tokensClaimed` variable is incorrectly calculated as 0, preventing users from claiming any tokens. This bug only affects users who initiated a withdrawal request when `sUSDe.cooldownDuration()` was set to `0`. The protocol team has fixed this issue in a recent PR.",
    "report_date": "2025-07-18T15:00:00.000Z",
    "contest_prize_txt": "75500 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1001",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-06-notional-exponent-judging/issues/263",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1001",
    "slug": "m-2-incorrect-tokensclaimed-calculation-in-ethenacooldownholder_finalizecooldown-blocks-withdrawals-sherlock-notional-exponent-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "Notional Exponent",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "X0sauce"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xDeoGratias"
            }
        },
        {
            "wardens_warden": {
                "handle": "xiaoming90"
            }
        },
        {
            "wardens_warden": {
                "handle": "hgrano"
            }
        },
        {
            "wardens_warden": {
                "handle": "patitonar"
            }
        },
        {
            "wardens_warden": {
                "handle": "elolpuer"
            }
        },
        {
            "wardens_warden": {
                "handle": "KungFuPa"
            }
        },
        {
            "wardens_warden": {
                "handle": "kangaroo"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xpiken"
            }
        },
        {
            "wardens_warden": {
                "handle": "pseudoArtist"
            }
        },
        {
            "wardens_warden": {
                "handle": "boredpukar"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xzey"
            }
        },
        {
            "wardens_warden": {
                "handle": "Ragnarok"
            }
        },
        {
            "wardens_warden": {
                "handle": "holtzzx"
            }
        },
        {
            "wardens_warden": {
                "handle": "bretzel"
            }
        },
        {
            "wardens_warden": {
                "handle": "touristS"
            }
        },
        {
            "wardens_warden": {
                "handle": "Schnilch"
            }
        },
        {
            "wardens_warden": {
                "handle": "Cybrid"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xc0ffEE"
            }
        },
        {
            "wardens_warden": {
                "handle": "almurhasan"
            }
        },
        {
            "wardens_warden": {
                "handle": "Atharv"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "Notional Exponent",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}