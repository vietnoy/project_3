{
    "id": 62026,
    "kind": "MARKDOWN",
    "auditfirm_id": 37,
    "impact": "HIGH",
    "finders_count": 3,
    "protocol_id": 3367,
    "title": "Lockup Period for Unstaking Can Be Decreased by Staking Again with Shorter Lockup Period",
    "content": "**Update**\nMarked as \"Fixed\" by the client. Addressed in: `c926eed4e5d707a63f34736158bd79873b8e0411` and `342795073d5d8abf2c3272f861cbbf63a4974774`.\n\n**File(s) affected:**`SapienVault.sol`\n\n**Description:** The `SapienVault` contract recalculates the effective lockup period when a user adds to an existing stake using the `stake()` function. The recalculation uses a **weighted average** between the current effective lockup period and the newly provided lockup period. This mechanism allows users to **reduce** their overall lockup duration by staking additional tokens with a shorter lockup period.\n\nAs a result, users can strategically lower their lockup commitment after the initial stake, undermining the intended locking mechanism.\n\n**Exploit Scenario:**\n\n1.   A user initially stakes 1,000 tokens with a 365-day lockup period.\n2.   Later, the user stakes an additional 10,000 tokens with a 30-day lockup period.\n3.   The weighted average lockup period is recalculated, heavily influenced by the new larger amount and shorter duration.\n4.   The new effective lockup period becomes significantly lower than 365 days, allowing the user to unlock all tokens earlier than originally committed.\n5.   The restaking can be repeated with a 30-day lockup period, further reducing the effective lockup duration.\n\n**Recommendation:** Disallow new stakes with shorter lockup periods than the existing commitment. Enforce that any additional stake must use a lockup period equal to or greater than the current one.",
    "summary": "\nThe client has marked a bug in the `SapienVault` contract as \"Fixed\". This bug allows users to reduce their lockup period by adding more tokens with a shorter lockup period. This undermines the intended locking mechanism. The bug can be exploited by staking an initial amount of tokens with a longer lockup period, and then adding more tokens with a shorter lockup period. This recalculates the effective lockup period, allowing the user to unlock their tokens earlier than originally committed. The recommendation is to disallow new stakes with shorter lockup periods and enforce that any additional stake must use a lockup period equal to or greater than the current one.",
    "report_date": "2025-07-02T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "https://certificate.quantstamp.com/full/sapien-2/9f938662-5bf7-4dc3-8774-3e7a12204cc3/index.html",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://certificate.quantstamp.com/full/sapien-2/9f938662-5bf7-4dc3-8774-3e7a12204cc3/index.html",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "lockup-period-for-unstaking-can-be-decreased-by-staking-again-with-shorter-lockup-period-quantstamp-sapien-2-markdown",
    "firm_name": "Quantstamp",
    "firm_logo_square": "quantstamp_square.png",
    "protocol_name": "Sapien - 2",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Paul Clemson"
            }
        },
        {
            "wardens_warden": {
                "handle": "Julio Aguilar"
            }
        },
        {
            "wardens_warden": {
                "handle": "Tim Sigl"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Quantstamp",
        "logo_square": "quantstamp_square.png"
    },
    "protocols_protocol": {
        "name": "Sapien - 2",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}