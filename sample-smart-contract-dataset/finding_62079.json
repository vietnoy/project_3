{
    "id": 62079,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "MEDIUM",
    "finders_count": 4,
    "protocol_id": 2159,
    "title": "[M-16] Removal of pool from reward zone does not allow gulping emissions which were already distributed in the past",
    "content": "\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/emissions/manager.rs# L195>\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/emissions/manager.rs# L232>\n\n### Finding description and impact\n\nThe [`BackstopContract::distribute`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/contract.rs# L257) is used to update the backstop with new emissions for all the reward zone pools.\n\nThen, calling the [`BackstopContract::gulp_emissions`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/contract.rs# L265) with a specific pool address will gulp emissions in the ratio of 70% to the backstop and 30% to the pool.\n\nA pool can be removed using the [`BackstopContract::remove_reward`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/contract.rs# L281) function if the threshold requirements are not met.\n```\n\n    pub fn remove_from_reward_zone(e: &Env, to_remove: Address) {\n        let mut reward_zone = storage::get_reward_zone(e);\n\n        // ensure to_add has met the minimum backstop deposit threshold\n        // NOTE: \"to_add\" can only carry a pool balance if it is a deployed pool from the factory\n        let pool_data = load_pool_backstop_data(e, &to_remove);\n        if require_pool_above_threshold(&pool_data) {           <<@ -- // Checks if a pool is above threshold and reverts\n            panic_with_error!(e, BackstopError::BadRequest);\n        } else {\n            remove_pool(e, &mut reward_zone, &to_remove);\n            storage::set_reward_zone(e, &reward_zone);\n        }\n    }\n```\n\nHowever, while removing the pool, the `remove_pool` sets the emission index to `i128::MAX` **without** allowing to claim the emissions via [`BackstopContract::gulp_emissions`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/contract.rs# L265) which were **already** distributed.\n```\n\n    /// Remove a pool from the reward zone and set the backstop emissions index to i128::MAX\n    fn remove_pool(e: &Env, reward_zone: &mut Vec<Address>, to_remove: &Address) {\n        let to_remove_index = reward_zone.first_index_of(to_remove.clone());\n        match to_remove_index {\n            Some(idx) => {\n                // . . . Rest of the code . . .\n                // update backstop emissions for the pool before removing it from the reward zone\n                // set emission index to i128::MAX to prevent further emissions\n                let to_remove_emis_data = storage::get_rz_emis_data(e, &to_remove).unwrap_optimized();\n                set_rz_emissions(e, &to_remove, i128::MAX, to_remove_emis_data.accrued, false);             <<@ -- // sets i128::MAX as the index\n\n                reward_zone.remove(idx);\n            }\n            None => panic_with_error!(e, BackstopError::InvalidRewardZoneEntry),\n        }\n    }\n```\n\nThis would fail the [`BackstopContract::gulp_emissions`](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/backstop/src/contract.rs# L265) call due to an overflow not allowing the rightful emissions to the pool and the backstop.\n```\n\n    pub fn gulp_emissions(e: &Env, pool: &Address) -> (i128, i128) {\n        let pool_balance = storage::get_pool_balance(e, pool);\n\n        let new_emissions = update_rz_emis_data(e, pool, true);         <<@ - // This call would revert\n        // . . . Rest of the code . . .\n        return (0, 0);\n    }\n```\n\nThe new emissions variable would overflow here as `gulp_index` is valid amount but the `emission_data.index` is set as `i128::MAX` whose difference will get multiplied by `SCALAR_14`, hence overflowing the signed 128 bit integer.\n```\n\n    pub fn update_rz_emis_data(e: &Env, pool: &Address, to_gulp: bool) -> i128 {\n        if let Some(emission_data) = storage::get_rz_emis_data(e, pool) {\n            let pool_balance = storage::get_pool_balance(e, pool);\n            let gulp_index = storage::get_rz_emission_index(e);\n            let mut accrued = emission_data.accrued;\n            if emission_data.index < gulp_index || to_gulp {\n                if pool_balance.non_queued_tokens() > 0 {\n                    let new_emissions = pool_balance\n                        .non_queued_tokens()\n                        .fixed_mul_floor(gulp_index - emission_data.index, SCALAR_14)           <<@ -- // Overflows here\n                        .unwrap_optimized();\n                    accrued += new_emissions;\n                    return set_rz_emissions(e, pool, gulp_index, accrued, to_gulp);\n                } else {\n                    return set_rz_emissions(e, pool, gulp_index, accrued, to_gulp);\n                }\n            }\n        }\n        return 0;\n    }\n```\n\nP.S: The distribute call was made prior to the pool being under threshold or simply some other pool got higher deposits than current.\n\n### Impact\n\n1. Loss of funds for the users and pool as the emissions were distributed before removal from reward zone, but the gulping of them is not allowed. There’s a possibility that the pool will never get added to the reward zone as pools are essentially competing with each other for a place in reward zone.\n2. Temporary funds stuck for the pool if there’s a chance it is added back to the reward zone.\n\n### Proof of Concept\n\nThe below test case was added inside `blend-contracts-v2/backstop/src/emissions/manager.rs` file:\n```\n\n    #[test]\n    #[should_panic]\n    fn test_remove_from_rz_failing_gulp() {\n        let e = Env::default();\n        e.ledger().set(LedgerInfo {\n            timestamp: 1713139200,\n            protocol_version: 22,\n            sequence_number: 0,\n            network_id: Default::default(),\n            base_reserve: 10,\n            min_temp_entry_ttl: 10,\n            min_persistent_entry_ttl: 10,\n            max_entry_ttl: 3110400,\n        });\n        e.mock_all_auths();\n\n        let bombadil = Address::generate(&e);\n        let backstop_id = create_backstop(&e);\n        let to_remove = Address::generate(&e);\n\n        let (blnd_id, _) = create_blnd_token(&e, &backstop_id, &bombadil);\n        let (usdc_id, _) = create_usdc_token(&e, &backstop_id, &bombadil);\n        create_comet_lp_pool_with_tokens_per_share(\n            &e,\n            &backstop_id,\n            &bombadil,\n            &blnd_id,\n            5_0000000,\n            &usdc_id,\n            0_1000000,\n        );\n        let mut reward_zone: Vec<Address> = vec![\n            &e,\n            Address::generate(&e),\n            to_remove.clone(), // index 7\n        ];\n\n        e.as_contract(&backstop_id, || {\n            storage::set_reward_zone(&e, &reward_zone);\n            storage::set_last_distribution_time(&e, &(1713139200 - 1 * 24 * 60 * 60));\n            storage::set_pool_balance(\n                &e,\n                &to_remove,\n                &PoolBalance {\n                    shares: 90_000_0000000,\n                    tokens: 100_001_0000000,\n                    q4w: 1_000_0000000,\n                },\n            );\n            storage::set_pool_balance(\n                &e,\n                &to_remove,\n                &PoolBalance {\n                    shares: 35_000_0000000,\n                    tokens: 40_000_0000000,\n                    q4w: 1_000_0000000,\n                },\n            );\n            storage::set_backstop_emis_data(\n                &e,\n                &to_remove,\n                &BackstopEmissionData {\n                    eps: 0_10000000000000,\n                    expiration: 1713139200 + 1000,\n                    index: 0,\n                    last_time: 1713139200 - 12345,\n                },\n            );\n            storage::set_rz_emis_data(&e, &to_remove, {\n                &RzEmissionData {\n                    index: 1234 * SCALAR_7,\n                    accrued: 0,\n                }\n            });\n            storage::set_rz_emission_index(&e, &(5678 * SCALAR_7));\n\nremove_from_reward_zone(&e, to_remove.clone());\n            let actual_rz = storage::get_reward_zone(&e);\n            reward_zone.remove(1);\n            assert_eq!(actual_rz.len(), 1);\n            assert_eq!(actual_rz, reward_zone);\n            // gulp emissions after removal\n            let ( fi, si ) = gulp_emissions(&e, &to_remove.clone());\n\n        });\n    }\n```\n\nAs we can infer, the function reverts as expected.\n\n### Recommended mitigation steps\n\nIt is recommended to gulp the emissions before removing the pool:\n```\n\n    pub fn add_to_reward_zone(e: &Env, to_add: Address, to_remove: Option<Address>) {\n\n        // . . . Rest of the code . . .\n\n        if MAX_RZ_SIZE > reward_zone.len() {\n            // there is room in the reward zone. Add \"to_add\".\n            reward_zone.push_front(to_add.clone());\n        } else {\n            match to_remove {\n                None => panic_with_error!(e, BackstopError::RewardZoneFull),\n                Some(to_remove) => {\n                    // Verify \"to_add\" has a higher backstop deposit that \"to_remove\"\n                    if pool_data.tokens <= storage::get_pool_balance(e, &to_remove).tokens {\n                        panic_with_error!(e, BackstopError::InvalidRewardZoneEntry);\n                    }\n+                    gulp_emissions(e, &to_remove);\n                    remove_pool(e, &mut reward_zone, &to_remove);\n                    reward_zone.push_front(to_add.clone());\n                }\n            }\n        }\n        // . . . Rest of the code . . .\n    }\n```\n\n**markus\\_pl10 (Script3) confirmed**\n\n**[Blend mitigated](https://github.com/code-423n4/2025-04-blend-mitigation?tab=readme-ov-file# mitigation-of-high--medium-severity-issues):**\n\n> [Commit 6204dba](https://github.com/blend-capital/blend-contracts-v2/pull/49/commits/6204dba1f935240a06f130026f3bf850c99a665d) to improve reward zone changes emissions impact.\n\n**Status:** Mitigation confirmed. Full details in reports from [Testerbot](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-78), [oakcobalt](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-36), [0xAlix2](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-12) and [0x007](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-48).\n\n---\n\n",
    "summary": "\nThis bug report discusses an issue found in the code for the Blend project. The code in question is used to update the backstop with new emissions for reward zone pools. However, there is a problem when trying to remove a pool from the reward zone. The code sets the emission index to a very high number, which causes an overflow when trying to distribute the emissions. This means that the rightful emissions to the pool and the backstop are not allowed, resulting in a loss of funds for users and pools. The report recommends mitigating this issue by gulping the emissions before removing the pool. The Blend team has confirmed and mitigated the issue.",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "125000",
    "contest_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "sponsor_name": "Blend",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "github_link": "https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-163",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "492",
    "slug": "m-16-removal-of-pool-from-reward-zone-does-not-allow-gulping-emissions-which-were-already-distributed-in-the-past-code4rena-blend-blend-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Blend",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "YouCrossTheLineAlfie"
            }
        },
        {
            "wardens_warden": {
                "handle": "rscodes"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xadrii"
            }
        },
        {
            "wardens_warden": {
                "handle": "monrel"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Blend",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}