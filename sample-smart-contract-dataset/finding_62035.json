{
    "id": 62035,
    "kind": "MARKDOWN",
    "auditfirm_id": 37,
    "impact": "HIGH",
    "finders_count": 4,
    "protocol_id": 3368,
    "title": "Missing Balance Deduction in Unstaking Functions Allows Contract Drainage and Lock Period Bypass",
    "content": "**Update**\nMarked as \"Fixed\" by the client. Addressed in: `4a45a4a`.\n\n![Image 26: Alert icon](https://certificate.quantstamp.com/full/sapien/ffb7e698-6178-46f0-8df8-52e537af70c0/static/media/success-icon-alert.4e26c8d3b65fdf9f4f0789a4086052ba.svg)\n\n**Update**\nMarked as \"Fixed\" by the client. Addressed in: `f647099b7988fa4d01fac6a9f3481d25e748527a`. The client provided the following explanation:\n\n> The vulnerability in the unstaking functions was fixed by implementing proper balance deduction and state management.\n\n![Image 27: Alert icon](https://certificate.quantstamp.com/full/sapien/ffb7e698-6178-46f0-8df8-52e537af70c0/static/media/success-icon-alert.4e26c8d3b65fdf9f4f0789a4086052ba.svg)\n\n**Update**\nMarked as \"Fixed\" by the client. Addressed in: `f647099b7988fa4d01fac6a9f3481d25e748527a`. The client provided the following explanation:\n\n> The vulnerability in the unstaking functions was fixed by implementing proper balance deduction and state management.\n\n**File(s) affected:**`SapienStaking.sol`\n\n**Description:** The `initiateUnstake()` and `unstake()` functions in the staking contract contain a critical vulnerability that allows users to drain the entire contract's token balance. When unstaking, the functions fail to deduct the staked amount from the user's balance in the `StakingInfo` struct. This means a user can:\n\n1.   Stake tokens once to create a valid staking position\n2.   Call `initiateUnstake()` to start the cooldown period\n3.   After the cooldown period, call `unstake()` multiple times with the same `orderId` to repeatedly withdraw tokens\n4.   Each withdrawal succeeds since the staking position remains active and the balance is never decremented\n\nAs a result, a malicious user could drain all tokens from the contract by repeatedly calling `unstake()` with a single valid staking position, far exceeding their initial stake.\n\nThis also tricks the reward mechanism off-chain, because the user `isActive` state variable is never updated, which signals that the user stake is still active, as well as having the original amount that was staked.\n\nIn addition to the above, the lock duration is not checked during unstaking. Meaning that an attacker can game the reward system by staking for the maximum duration, and then unstake immediately.\n\n**Exploit Scenario:**\n\n1.   Alice stakes 100 tokens and receives a valid `orderId` and signature\n2.   Alice initiates unstaking by calling `initiateUnstake()`\n3.   After the cooldown period completes, Alice calls `unstake()` to withdraw 100 tokens\n4.   Since her staking position remains active and unchanged, Alice can call `unstake()` again\n5.   Alice can repeat this process until the contract's entire token balance is drained\n\n**Recommendation:** Modify the `unstake()` function to properly update the user's staking position. Also, add checks for the lockdown duration.",
    "summary": "\nThis bug report is about a vulnerability in the `SapienStaking.sol` contract, where users can drain all tokens from the contract by repeatedly calling the `unstake()` function. This is because the contract fails to deduct the staked amount from the user's balance, allowing them to withdraw more tokens than they initially staked. This also tricks the reward system off-chain, as the user's staking position is never updated. The report recommends modifying the `unstake()` function and adding checks for the lockdown duration to fix this issue. The client has marked this bug as \"Fixed\" and provided an explanation for the fix.",
    "report_date": "2025-03-30T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "https://certificate.quantstamp.com/full/sapien/ffb7e698-6178-46f0-8df8-52e537af70c0/index.html",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://certificate.quantstamp.com/full/sapien/ffb7e698-6178-46f0-8df8-52e537af70c0/index.html",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "missing-balance-deduction-in-unstaking-functions-allows-contract-drainage-and-lock-period-bypass-quantstamp-sapien-markdown",
    "firm_name": "Quantstamp",
    "firm_logo_square": "quantstamp_square.png",
    "protocol_name": "Sapien",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Paul Clemson"
            }
        },
        {
            "wardens_warden": {
                "handle": "Julio Aguilar"
            }
        },
        {
            "wardens_warden": {
                "handle": "Mostafa Yassin"
            }
        },
        {
            "wardens_warden": {
                "handle": "Tim Sigl"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Quantstamp",
        "logo_square": "quantstamp_square.png"
    },
    "protocols_protocol": {
        "name": "Sapien",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}