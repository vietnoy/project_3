{
    "id": 62663,
    "kind": "MARKDOWN",
    "auditfirm_id": 23,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 3435,
    "title": "Flawed Precision and Scaling Logic in `price()`",
    "content": "##### Description\nThe `price()` function in `ChainlinkCompositeOracleProvider` begins with a 36-decimal fixed-point accumulator (`highPrecisionPrice = PRECISION`). Each feed is then folded into that value, but two subtle arithmetic mistakes distort the final price:\n\n1. **Inverted feeds (`isInverted == true`)**\n   The code multiplies the accumulator by `(10**assetDecimals) * (10**feed.decimals()) / feedPrice`.\n   Because both exponents are reapplied for every inverted feed, the precision scale increases by `assetDecimals` on each iteration, corrupting the effective price by several orders of magnitude, or exceeding the 256-bit limit causing overflow.\n\n2. **Non-inverted feeds (`isInverted == false`)**\n   Here, the accumulator is multiplied by `feedPrice` and divided by `10**currentDecimals`, that keeps the scale of price. When all feeds are non-inverted, the accumulator retains its initial 36-decimal offset while the final division by `PRECISION` truncates all fractional data, returning a whole-number price.\n\nCombined, these errors can cause large under- or over-flows, creating a clear path for profitable arbitrage in outer contracts. Hence, the issue is classified as **High** severity.\n\n##### Recommendation\nWe recommend adopting a uniform fixed-point workflow that keeps every intermediate value on the same scale:\n```solidity\nuint256 rate = cfg.isInverted\n    ? SCALING_FACTOR.mulDiv(\n        10 ** config.feed.decimals(),\n        uint256(feedPrice)\n    )\n    : uint256(feedPrice) * (\n        10 ** (SCALING_DECIMALS - config.feed.decimals())\n    );\n\nhighPrecisionPrice = highPrecisionPrice.mulDiv(\n    rate,\n    SCALING_FACTOR\n);\n\n```\nand only converts to final decimals once, at the very end:\n```solidity\nreturn highPrecisionPrice.mulDiv(10 ** this.decimals(), SCALING_FACTOR);\n```\n",
    "summary": "\nThe bug report is about a function called `price()` in the `ChainlinkCompositeOracleProvider` code. This function starts with a 36-decimal fixed-point accumulator. However, there are two mistakes in the code that distort the final price. \n\nThe first mistake occurs when dealing with inverted feeds (where `isInverted == true`). The code multiplies the accumulator by `(10**assetDecimals) * (10**feed.decimals()) / feedPrice`. This causes the precision scale to increase by `assetDecimals` on each iteration, which can lead to incorrect prices or an overflow error. \n\nThe second mistake happens with non-inverted feeds (where `isInverted == false`). In this case, the accumulator is multiplied by `feedPrice` and divided by `10**currentDecimals`, which maintains the scale of the price. However, when all feeds are non-inverted, the final division by `PRECISION` truncates all fractional data, resulting in a whole-number price. \n\nThese errors can lead to significant discrepancies in prices, making it possible for people to profit from arbitrage opportunities. Therefore, the issue is classified as high severity. \n\nTo fix these mistakes, the recommendation is to use a uniform fixed-point workflow that keeps all intermediate values on the same scale. This can be achieved by using the code snippet provided in the report. The final decimal conversion should only be done at the very end, before returning the price.",
    "report_date": "2025-09-19T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/mixbytes/audits_public/blob/master/NUTS%20Finance/Tapio/README.md#4-flawed-precision-and-scaling-logic-in-price",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "flawed-precision-and-scaling-logic-in-price-mixbytes-none-nuts-finance-markdown",
    "firm_name": "MixBytes",
    "firm_logo_square": "mixbytes_square.png",
    "protocol_name": "NUTS Finance",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "MixBytes"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "MixBytes",
        "logo_square": "mixbytes_square.png"
    },
    "protocols_protocol": {
        "name": "NUTS Finance",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}