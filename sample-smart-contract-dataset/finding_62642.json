{
    "id": 62642,
    "kind": "MARKDOWN",
    "auditfirm_id": 30,
    "impact": "MEDIUM",
    "finders_count": 1,
    "protocol_id": 3429,
    "title": "[M-03] Protocol Prioritises Lower Level Users, Hence Robbing the Higher Level Ones of Commissions",
    "content": "\n## Severity\n\nMedium Risk\n\n## Description\n\nLet's investigate the flow of the following scenario:\n`L0 => L5 => L1`\n\nThe L0 user wants to directly connect with the specific L5 user and pay the 12% commission to him. The problem in this example will be that the L5 account parent is an L1 account, which, as of this moment, will be accounted for by the protocol and both the parents will receive as follows:\n`L1 == 4%`\n`L5 == 8%`\n\nWhich will not be what the `L0` user desires. On top of that, the `L0` user will be obligated to pay more gas because of the loop in the `BondDealer::_getHigherLevelParents()` function.\n\n## Location of Affected Code\n\nFile: [src/BondDealer.sol#L250](https://github.com/batoshidao/berabtc-vault-token/blob/c68f412b3c7dfd99d3f6302a42bdf772ededb2a3/src/BondDealer.sol#L250)\n\n```solidity\nfunction _getHigherLevelParents(address user) internal view returns (UserInfo[] memory) {\n  // code\n  // Traverse up the parent chain\n  for (uint256 hop = 0; hop < 64 && cur != address(0); hop++) {\n      UserInfo memory parent = userInfos[cur];\n      uint256 parentLevel = uint256(parent.level);\n\n      // Only consider parents with higher level than current user\n      if (parentLevel > currentLevel && !found[parentLevel]) {\n          higherLevelParents[parentLevel] = parent;\n          found[parentLevel] = true;\n          count++;\n          // If we found all possible higher levels, we can stop\n          //FIXME: This can stop when level 5 is found\n          if (count == 6 - currentLevel - 1) break;\n      }\n      cur = parent.parent;\n  }\n  // code\n}\n```\n\n## Impact\n\nUsers are obligated to pay more gas and the Level 5 users are essentially robbed of their commission rates\n\n## Recommendation\n\nConsider fixing the code like this:\n\n```diff\nfor (uint256 hop = 0; hop < 64 && cur != address(0); hop++) {\n    UserInfo memory parent = userInfos[cur];\n    uint256 parentLevel = uint256(parent.level);\n\n    // Only consider parents with a higher level than the current user\n    if (parentLevel > currentLevel && !found[parentLevel]) {\n        higherLevelParents[parentLevel] = parent;\n        found[parentLevel] = true;\n        count++;\n        // If we found all possible higher levels, we can stop\n        //FIXME: This can stop when level 5 is found\n        if (count == 6 - currentLevel - 1) break;\n    }\n+   currentLevel =uint256( parent.level);\n+   if (currentLevel == 6) break;\n    cur = parent.parent;\n}\n```\n\nThis way, the user will be able to start from a specific level without going down the ladder and paying commission to dealers he doesn't want to.\n\n## Team Response\n\nFixed.\n\n",
    "summary": "\nThis bug report discusses an issue in the code that affects users who want to directly connect with a specific user and pay them a commission. Currently, the code does not account for the fact that the specific user's parent may also receive a commission, resulting in the user paying more gas and the specific user being robbed of their commission. The recommendation is to fix the code so that the user can start from a specific level without going down the ladder and paying commission to unwanted dealers. The team has responded that the issue has been fixed.",
    "report_date": "2025-09-17T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/shieldify-security/audits-portfolio-md/blob/main/Terplayer-BVT-Staking&Distribution-Security-Review.md",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "m-03-protocol-prioritises-lower-level-users-hence-robbing-the-higher-level-ones-of-commissions-shieldify-none-terplayer-bvt-stakingdistribution-markdown",
    "firm_name": "Shieldify",
    "firm_logo_square": "Shieldify_square.png",
    "protocol_name": "Terplayer Bvt Staking&Distribution",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Shieldify Security"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Shieldify",
        "logo_square": "Shieldify_square.png"
    },
    "protocols_protocol": {
        "name": "Terplayer Bvt Staking&Distribution",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}