{
    "id": 62737,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "MEDIUM",
    "finders_count": 15,
    "protocol_id": 3324,
    "title": "M-14: MixedPriceOracleV4.sol :: getUnderlyingPrice()/getPirce() will not work for some tokens because API3 and EO oracles return prices using different decimals, causing DOS scenario.",
    "content": "\nSource: https://github.com/sherlock-audit/2025-07-malda-judging/issues/945 \n\n## Found by \n0xEkko, 0xfocusNode, 10ap17, Cybrid, HeckerTrieuTien, IvanFitro, KiroBrejka, PeterSR, SafetyBytes, ZanyBonzy, Ziusz, axelot, dan\\_\\_vinci, elolpuer, pashap9990\n\n### Summary\n\n`getUnderlyingPrice()`/`getPrice()` are used to obtain the price of the assets in USD. It does this by querying two different oracles, in this case, API3 and EO oracles. The problem is that these oracles return prices with different decimals, causing the function to always end up using the EO oracle’s price.\n\n\n### Root Cause\n\n[getUnderlyingPrice()](https://github.com/sherlock-audit/2025-07-malda/blob/798d00b879b8412ca4049ba09dba5ae42464cfe7/malda-lending/src/oracles/MixedPriceOracleV4.sol#L114) calls `_getPriceUSD()`, which in turn calls `_getLatestPrice()`, implemented as follows:\n```solidity\nfunction _getLatestPrice(string memory symbol, PriceConfig memory config)\n        internal\n        view\n        returns (uint256, uint256)\n    {\n        if (config.api3Feed == address(0) || config.eOracleFeed == address(0)) revert MixedPriceOracle_MissingFeed();\n\n        //get both prices\n@>      (, int256 apiV3Price,, uint256 apiV3UpdatedAt,) = IDefaultAdapter(config.api3Feed).latestRoundData();\n@>      (, int256 eOraclePrice,, uint256 eOracleUpdatedAt,) = IDefaultAdapter(config.eOracleFeed).latestRoundData(); \n        // check if ApiV3 price is up to date\n        uint256 _staleness = _getStaleness(symbol);\n        bool apiV3Fresh = block.timestamp - apiV3UpdatedAt <= _staleness;\n\n        // check delta\n@>      uint256 delta = _absDiff(apiV3Price, eOraclePrice);\n        uint256 deltaBps = (delta * PRICE_DELTA_EXP) / uint256(eOraclePrice < 0 ? -eOraclePrice : eOraclePrice);\n\n        uint256 deltaSymbol = deltaPerSymbol[symbol];\n        if (deltaSymbol == 0) {\n            deltaSymbol = maxPriceDelta;\n        }\n\n        uint256 decimals;\n        uint256 uPrice;\n@>        if (!apiV3Fresh || deltaBps > deltaSymbol) {\n            require(block.timestamp - eOracleUpdatedAt < _staleness, MixedPriceOracle_eOracleStalePrice());\n            decimals = IDefaultAdapter(config.eOracleFeed).decimals();\n            uPrice = uint256(eOraclePrice);\n         } else {\n            require(block.timestamp - apiV3UpdatedAt < _staleness, MixedPriceOracle_ApiV3StalePrice());\n            decimals = IDefaultAdapter(config.api3Feed).decimals();\n            uPrice = uint256(apiV3Price);\n        }\n\n        return (uPrice, decimals);\n    }\n```\nAs you can see, it obtains the price from both oracles and calculates the absolute difference using `_absDiff()`:\n```solidity\n function _absDiff(int256 a, int256 b) internal pure returns (uint256) {\n        return uint256(a >= b ? a - b : b - a);\n    }\n```\nThe problem is that the oracles do not return prices with the same decimals. According to the documentation, API3 always returns prices with [18 decimals](https://docs.api3.org/dapps/integration/contract-integration.html#using-value), while the EO oracle almost always returns prices with [8 decimals](https://docs.eo.app/docs/eprice/feeds-addresses/price-feed-addresses/linea).\n\nAs a result, `_absDiff()` ends up calculating the difference between an 18-decimal price and an 8-decimal price, producing an incorrect delta. This delta will be disproportionately large—essentially because `18 decimals - 8 decimals ≈ 18 decimals`—causing the first `if` condition to be triggered almost every time (because `_delta` is capped by `PRICE_DELTA_EXP = 1e5`). This leads to always selecting the EO oracle’s price, effectively making the dual-oracle setup useless.\n\nAlways entering the first `if` is problematic because if `apiV3Fresh = true` (meaning the API3 price is not stale) but the EO oracle price **is** stale, the transaction will still revert with `MixedPriceOracle_eOracleStalePrice()`. This happens even when the prices themselves are correct, simply because `deltaBps > deltaSymbol` is true due to the decimal mismatch. As a result, it creates a DOS for obtaining the price, when in reality the price could be retrieved using API3 orcale if the decimals from both oracles were adjusted correctly.\n\n### Internal Pre-conditions\n\nNone.\n\n### External Pre-conditions\n\nAPI decimals > EO decimals or vice versa.\nAPI price is fresh, and EO price is stale.\n\n### Attack Path\n\nNone.\n\n### Impact\n\nThThe price obtained using `getUnderlyingPrice()` will always come from the EO oracle. If the EO price is stale while the API3 price is fresh, the price cannot be obtained, creating a denial-of-service (DoS) scenario.\n\n### PoC\n\nTo illustrate the problem, let’s use the [wBTC / USD](https://docs.eo.app/docs/eprice/feeds-addresses/price-feed-addresses/linea) pair on the Linea chain, which is in scope for the contest. In the EO oracle, the price is returned with 8 decimals, while in API3 it’s returned with 18 decimals.\n\n1. `getUnderlyingPrice()` is called for an mToken whose underlying asset is wBTC.\n2. The EO oracle price is `120000000000` (8 decimals), and the API3 oracle price is `120000000000000000000000` (18 decimals). The API3 price is fresh, while the EO oracle price is stale.\n3. `_absDiff()` is calculated as `120000000000000000000000 - 120000000000 ≈ 120000000000000000000000`, producing a very large delta.\n4. Because `deltaBps` is much greater than `deltaSymbol`, the first `if` condition is triggered, selecting the EO oracle’s price. However, this reverts because the EO price is stale.\n\nIf `deltaBps` were calculated correctly, the `else` branch would be taken, and the fresh API3 price would be used. In the current implementation, this creates a denial of service (DoS) scenario where the price cannot be obtained.\n\n### Mitigation\n\nTo solve the problem, normalize the decimals from both oracles before calculating `_absDiff()`, ensuring the `deltaBps` is computed correctly.\n\n\n## Discussion\n\n**sherlock-admin2**\n\nThe protocol team fixed this issue in the following PRs/commits:\nhttps://github.com/malda-protocol/malda-lending/pull/134\n\n\n**CergyK**\n\nFix looks good, as already mentioned in \\#1305\n\n\n\n",
    "summary": "\nThe bug report discusses an issue with the `getUnderlyingPrice()` and `getPrice()` functions that are used to obtain the price of assets in USD. These functions query two different oracles, but due to a difference in the number of decimals returned by each oracle, the function always ends up using the price from one oracle. This can lead to incorrect prices and a denial-of-service (DoS) scenario. The bug has been fixed by normalizing the decimals from both oracles before calculating the price difference.",
    "report_date": "2025-08-14T17:00:00.000Z",
    "contest_prize_txt": "80000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1029",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-07-malda-judging/issues/945",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1029",
    "slug": "m-14-mixedpriceoraclev4sol-getunderlyingpricegetpirce-will-not-work-for-some-tokens-because-api3-and-eo-oracles-return-prices-using-different-decimals-causing-dos-scenario-sherlock-malda-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "Malda",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "IvanFitro"
            }
        },
        {
            "wardens_warden": {
                "handle": "ZanyBonzy"
            }
        },
        {
            "wardens_warden": {
                "handle": "HeckerTrieuTien"
            }
        },
        {
            "wardens_warden": {
                "handle": "elolpuer"
            }
        },
        {
            "wardens_warden": {
                "handle": "dan\\_\\_vinci"
            }
        },
        {
            "wardens_warden": {
                "handle": "KiroBrejka"
            }
        },
        {
            "wardens_warden": {
                "handle": "10ap17"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xEkko"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xfocusNode"
            }
        },
        {
            "wardens_warden": {
                "handle": "axelot"
            }
        },
        {
            "wardens_warden": {
                "handle": "pashap9990"
            }
        },
        {
            "wardens_warden": {
                "handle": "Cybrid"
            }
        },
        {
            "wardens_warden": {
                "handle": "dan\\_\\_vinci"
            }
        },
        {
            "wardens_warden": {
                "handle": "PeterSR"
            }
        },
        {
            "wardens_warden": {
                "handle": "SafetyBytes"
            }
        },
        {
            "wardens_warden": {
                "handle": "Ziusz"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "Malda",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}