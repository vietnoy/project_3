{
    "id": 62809,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "HIGH",
    "finders_count": 2,
    "protocol_id": 3398,
    "title": "H-2: Users' voting weight can be double-counted when finalize epoch is processed in multiple steps",
    "content": "\nSource: https://github.com/sherlock-audit/2025-09-bmx-deli-swap-judging/issues/62 \n\n## Found by \nblockace, cergyk\n\n### Description\n\nIn `Voter.sol`, the admin can call `finalizeEpoch` in order to tally all of the votes when an epoch has ended. Since the list of voters can be unbounded, finalizing can be broken into multiple steps in order to avoid DOS by OOG.\n\nUnfortunately, when tallying the votes, the current balance of `SBF_BMX` is used, which allows a manipulation of the result by malicious actors:\n\n[Voter.sol#L338-L369](https://github.com/sherlock-audit/2025-09-bmx-deli-swap/blob/main/deli-swap-contracts/src/Voter.sol#L338-L369):\n```solidity\n    /// @dev Processes up to `maxBatch` auto-voters for `ep`, adding live balances to option weights.\n    function _tallyAutoVotes(uint256 ep, uint256 maxBatch) internal returns (bool finished) {\n        EpochData storage e = epochInfo[ep];\n        uint256 processed;\n        while (processed < maxBatch && batchCursor[ep] < autoVoterList.length) {\n            uint256 i = batchCursor[ep];\n            address voterAddr = autoVoterList[i];\n            batchCursor[ep] = i + 1;\n            processed++;\n\n            uint8 opt = autoOption[voterAddr];\n            if (opt >= 3) continue; // disabled\n            if (userVoteWeight[ep][voterAddr] > 0) continue;\n\n\n            //@audit current balance is used for voterAddr\n>>          uint256 bal = SBF_BMX.balanceOf(voterAddr);\n            if (bal == 0) {\n                // queue for removal instead of removing now\n                pendingRemovals[ep].push(voterAddr);\n                continue;\n            }\n            e.optionWeight[opt] += bal;\n            userVoteWeight[ep][voterAddr] = bal;\n            userChoice[ep][voterAddr] = opt;\n        }\n\n\n        finished = (batchCursor[ep] >= autoVoterList.length);\n\n\n        // process removals only after loop is complete\n        if (finished && pendingRemovals[ep].length > 0) {\n            _processPendingRemovals(ep);\n        }\n    }\n```\n\n### Concrete scenario\n\nThe admin separates the processing of autoVotes into 2 transactions, and Alice controls 2 addresses `voterAddressA` (included in the first batch) and `voterAddressB` (included in the second batch). \n\nBetween the 2 admin transactions, Alice unstakes her `sbfBMX` from `voterAddressA` and stakes to `voterAddressB`.\n\nSince the balance of `sbfBMX` at the time of admin calling is used, the `sbfBMX` from `voterAddressA` will be counted again when `voterAddressB` is processed during the second admin call.\n\nAlice has successfully manipulated the result of the vote.\n\n### Recommendation\n\nEither restrict staking of sBMX when `finalizationInProgress`, or use a snapshotting system which would get the latest `userVoteWeight[prevEp][voterAddr]` where `prevEp` is the latest epoch where `userVoteWeight` was updated.\n\n",
    "summary": "\nThis bug report describes an issue in the `Voter.sol` contract where the admin can call `finalizeEpoch` to tally votes at the end of an epoch. However, the current balance of `SBF_BMX` is used in the tallying process, which allows for manipulation by malicious actors. The report suggests restricting staking during the finalization process or implementing a snapshotting system to prevent this issue. ",
    "report_date": "2025-09-16T15:00:00.000Z",
    "contest_prize_txt": "47000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1154",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-09-bmx-deli-swap-judging/issues/62",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1154",
    "slug": "h-2-users-voting-weight-can-be-double-counted-when-finalize-epoch-is-processed-in-multiple-steps-sherlock-bmx-deli-swap-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "BMX Deli Swap",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "cergyk"
            }
        },
        {
            "wardens_warden": {
                "handle": "blockace"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "BMX Deli Swap",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}