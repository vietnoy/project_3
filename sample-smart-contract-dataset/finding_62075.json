{
    "id": 62075,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "MEDIUM",
    "finders_count": 1,
    "protocol_id": 2159,
    "title": "[M-12] Malicious actors can repeatedly dilute emissions to a longer timeframe",
    "content": "\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/contract.rs# L502-L508>\n\n### Summary\n```\n\npub fn gulp_emissions(e: &Env) -> i128 {\n    let backstop = storage::get_backstop(e);\n    let new_emissions =\n        BackstopClient::new(e, &backstop).gulp_emissions(&e.current_contract_address());\n    do_gulp_emissions(e, new_emissions);\n    new_emissions\n}\n```\n\nIn the pool folder contracts, `gulp_emissions` allow any users to call it. It will then fetch the emissions from the backstop pool, record it under the variable `new_emissions` and distribute it with `do_gulp_emissions(e, new_emissions)`.\n\n`do_gulp_emissions` then calls `update_reserve_emission_eps` to adjust the new timeframe and new eps.\n```\n\nfn update_reserve_emission_eps(\n    e: &Env,\n    reserve_config: &ReserveConfig,\n    asset: &Address,\n    res_token_id: u32,\n    new_reserve_emissions: i128,\n) {\n    ....\n    let expiration: u64 = e.ledger().timestamp() + 7 * 24 * 60 * 60; //@my_comment <---- new expiration date\n\n    if let Some(mut emission_data) = distributor::update_emission_data(\n        e,\n        res_token_id,\n        supply,\n        10i128.pow(reserve_config.decimals),\n    ) {\n        // data exists - update it with old config\n\n        if emission_data.last_time != e.ledger().timestamp() {\n            // force the emission data to be updated to the current timestamp\n            emission_data.last_time = e.ledger().timestamp();\n        }\n        // determine the amount of tokens not emitted from the last config\n        if emission_data.expiration > e.ledger().timestamp() {\n            let time_since_last_emission = emission_data.expiration - e.ledger().timestamp();\n\n            // Eps is scaled by 14 decimals\n            let tokens_since_last_emission = i128(emission_data.eps).fixed_mul_floor(\n                e,\n                &i128(time_since_last_emission),\n                &SCALAR_7,\n            );\n-->         tokens_left_to_emit += tokens_since_last_emission;\n        }\n\n-->     let eps = u64(tokens_left_to_emit * SCALAR_7 / (7 * 24 * 60 * 60)).unwrap_optimized();\n\n        emission_data.expiration = expiration;\n        emission_data.eps = eps;\n        storage::set_res_emis_data(e, &res_token_id, &emission_data);\n        PoolEvents::reserve_emission_update(e, res_token_id, eps, expiration);\n    } else {\n        ....\n    }\n}\n```\n\nAs shown by the code, it will calculate the **new expiration time** and calculate the previous **un-distributed** rewards before diluting it over the new expiration timestamp.\n\nThere is no restriction on the minimum time that has to pass before this function can be called. If we look at `do_gulp_emissions` we can see that the only restriction is on the value of `new_emissions`. (Comment is the original comment from the code).\n```\n\nfn do_gulp_emissions(e: &Env, new_emissions: i128) {\n  // ensure enough tokens are being emitted to avoid rounding issues\n  if new_emissions < SCALAR_7 {\n      panic_with_error!(e, PoolError::BadRequest)\n  }\n  ...\n}\n```\n\nThe emission token has 7 decimal places, so that means this can be called whenever there is **1 token to be emittted** with **no minimum time** that must pass before it could be called again.\n\n### Impact\n\nThis bug has been reported before in some audit’s and accepted as a Medium in such as the [Infrared audit on Cantina](https://cantina.xyz/code/ac5f64e6-3bf2-4269-bbb0-4bcd70425a1d/findings/445), as well as the Loopfi July Code4rena audit.\n\nBasically, the impact is that since there is no minimum time that must pass before the function can be called again, anyone can **repeatedly dilute the existing rewards into a longer timeframe to delay the emissions of the reward**.\n\nUsers who do not have free funds now, and only plan to deposit sometime in the near future can consistently carry out this attack (like say every 3 minutes) and cause existing rewards to get diluted into the future timeframe. (**and that’s extremely unfair to current stakers**).\n\n### Recommended mitigation steps\n\nAdd a minimum time duration that must pass before `gulp_emissions` can be called again. That way users cannot repeatedly dilute the rewards into a longer timeframe which is unfair for current stakers.\n\n**markus\\_pl10 (Script3) disputed**\n\n**[mootz12 (Script3) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-53?commentParent=XwTygLfEhjj):**\n\n> This is probably not an issue. There is a minimum time that must pass before distribute can be called on the backstop (the source for all emissions), which helps mitigate this, as it can only be called once per hour. Also, the min balance check on `gulp_emissions` prevents emissions from being updated after emissions have stopped being directed towards a pool.\n>\n> Even in the case where a specific reserve loses it’s emission status, it will not have it’s emissions config updated.\n>\n> The only case this might impact something is when a reserve gets added, and spamming `gulp_emissions` every hour might make it take longer for the emissions to “reach full steam”. However, I’m not confident this is true.\n\n**[LSDan (judge) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-53?commentParent=XwTygLfEhjj&commentChild=QUgnRKS48ME):**\n\n> This is a hand-wavy hypothetical report that does point to an issue where the protocol would not function as expected and there may be loss of unmatured / unrealized yield ([reference](https://docs.code4rena.com/awarding/judging-criteria/supreme-court-decisions-fall-2023# verdict-loss-of-yield-as-high)). As such, it fits as a valid medium.\n\n**[mootz12 (Script3) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-53?commentParent=6QhjTb7vTyE):**\n\n> Fixed to:\n>\n> * Create better bounds on when distribute and gulp are run.\n> * This fix was primarily for cleaning up reward zone changes, but does fix this as well, given gulp can only be run once a day per pool.\n\n**[Blend mitigated](https://github.com/code-423n4/2025-04-blend-mitigation?tab=readme-ov-file# mitigation-of-high--medium-severity-issues):**\n\n> [Commit 6204dba](https://github.com/blend-capital/blend-contracts-v2/pull/49/commits/6204dba1f935240a06f130026f3bf850c99a665d) to improve reward zone changes emissions impact.\n\n**Status:** Mitigation confirmed. Full details in reports from [oakcobalt](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-32), [0xAlix2](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-11), [0x007](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-56) and [Testerbot](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-74).\n\n---\n\n",
    "summary": "\nThe report describes a bug in the code of the Blend project's pool contracts. The bug allows any user to repeatedly dilute the existing rewards into a longer timeframe, delaying the distribution of rewards to other users. This is considered unfair to current stakers. The report recommends adding a minimum time duration before the function can be called again to prevent this issue. The project has confirmed the bug and implemented a fix. ",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "125000",
    "contest_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "sponsor_name": "Blend",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "github_link": "https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-53",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "492",
    "slug": "m-12-malicious-actors-can-repeatedly-dilute-emissions-to-a-longer-timeframe-code4rena-blend-blend-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Blend",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "rscodes"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Blend",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}