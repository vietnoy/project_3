{
    "id": 62092,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "HIGH",
    "finders_count": 13,
    "protocol_id": 1174,
    "title": "[H-01] The `poolExposure` for token1 is erroneously calculated as `shortPremium - longPremium;`",
    "content": "\n\n<https://github.com/code-423n4/2025-06-panoptic/blob/8ef6d867a5fb6ffd1a6cc479a2380a611d452b4a/src/accountants/PanopticVaultAccountant.sol# L134-L136>\n\n### Finding description and impact\n\n`getAccumulatedFeesAndPositionsData` returns the total amount of premium `owed to the short legs` and the total amount of premium `owned by the long legs`. This means that the `shortPremium` is an asset for the Vault and the `longPremium` is a liability. The assets must be added to the NAV while the liabilities must be subtracted from the NAV.\n\nThe `poolExposure0` calculates correctly the exposure in token0 by subtracting the `longPremium` from the `shortPremium`. For the `poolExposure1` these 2 premiums are reversed: the `shortPremium` is wrongly subtracted from the `longPremium`:\n```\n\n    function computeNAV(\n        address vault,\n        address underlyingToken,\n        bytes calldata managerInput\n    ) external view returns (uint256 nav) {\n...\n            int256 poolExposure0;\n            int256 poolExposure1;\n            {\n                LeftRightUnsigned shortPremium;\n                LeftRightUnsigned longPremium;\n\n                (shortPremium, longPremium, positionBalanceArray) = pools[i]\n                    .pool\n                    .getAccumulatedFeesAndPositionsData(_vault, true, tokenIds[i]);\n\n                poolExposure0 =\n                    int256(uint256(shortPremium.rightSlot())) -\n                    int256(uint256(longPremium.rightSlot()));\n                poolExposure1 =\n@>                    int256(uint256(longPremium.leftSlot())) -\n@>                    int256(uint256(shortPremium.leftSlot()));\n            }\n```\n\nThese 2 exposures are converted to the `underlying` token and summed to calculate the vaultâ€™s NAV.\nThe `computeNAV()` function will return a wrong value.\n\nThe `sharesReceived`, when deposits are fulfilled and the `assetsReceived` on fulfill withdrawals from the HypoVault, will have incorrect values. Users can receive more (or less) shares as well as getting back less (or more) assets.\n\n### Recommended mitigation steps\n\nCalculate the `poolExposure1` the same way `poolExposure0` is calculated:\n```\n\n            {\n                LeftRightUnsigned shortPremium;\n                LeftRightUnsigned longPremium;\n\n                (shortPremium, longPremium, positionBalanceArray) = pools[i]\n                    .pool\n                    .getAccumulatedFeesAndPositionsData(_vault, true, tokenIds[i]);\n\n                poolExposure0 =\n                    int256(uint256(shortPremium.rightSlot())) -\n                    int256(uint256(longPremium.rightSlot()));\n                poolExposure1 =\n-                    int256(uint256(longPremium.leftSlot())) -\n-                    int256(uint256(shortPremium.leftSlot()));\n+                    int256(uint256(shortPremium.leftSlot())) -\n+                    int256(uint256(longPremium.leftSlot()));\n            }\n```\n\n### Proof of Concept\n\nThe test `test_computeNAV_exactCalculation_withExactPremiums` fails to detect this issue because the tolerance used in assert is too high - 50% of the NAV.\n\nTo better show the issue, the following test uses slightly different values for premium. Add the following code to `PoC.t.sol file` and execute it with `forge test --mt test_submissionValidity -vvv`.\n\nThe test fails with `[FAIL: NAV should include underlying plus converted premiums: 1048995033790712343115 !~= 1250000000000000000000 (max delta: 10000000000000000000, real delta: 201004966209287656885)]` error message:\n```\n\n    function test_submissionValidity() public {\n        // Create pools where token0 is underlying - only token1 needs conversion\n        PanopticVaultAccountant.PoolInfo[] memory pools = new PanopticVaultAccountant.PoolInfo[](1);\n        pools[0] = PanopticVaultAccountant.PoolInfo({\n            pool: PanopticPool(address(mockPool)),\n            token0: underlyingToken, // Same as underlying\n            token1: token1,\n            poolOracle: poolOracle,\n            oracle0: oracle0,\n            isUnderlyingToken0InOracle0: true,\n            oracle1: oracle1,\n            isUnderlyingToken0InOracle1: false,\n            maxPriceDeviation: MAX_PRICE_DEVIATION,\n            twapWindow: TWAP_WINDOW\n        });\n        address vault = address(vault);\n        accountant.updatePoolsHash(vault, keccak256(abi.encode(pools)));\n\n        // Setup scenario with no token balances, only collateral and premiums\n        underlyingToken.setBalance(vault, 1000e18);\n        token1.setBalance(vault, 0); // No token1 balance\n        mockPool.collateralToken0().setBalance(vault, 0); // No collateral\n        mockPool.collateralToken0().setPreviewRedeemReturn(0);\n        mockPool.collateralToken1().setBalance(vault, 0);\n        mockPool.collateralToken1().setPreviewRedeemReturn(0);\n\n        uint256 shortPremiumRight = 200e18;\n        uint256 shortPremiumLeft = 150e18;\n        uint256 longPremiumRight = 50e18;\n        uint256 longPremiumLeft = 50e18;\n        uint256 net = (shortPremiumRight - longPremiumRight) + (shortPremiumLeft - longPremiumLeft);\n        assertEq(net, 250e18, \"Net premium should be 250 ether\");\n        mockPool.setMockPremiums(\n            LeftRightUnsigned.wrap((shortPremiumLeft << 128) | shortPremiumRight),\n            LeftRightUnsigned.wrap((longPremiumLeft << 128) | longPremiumRight)\n        );\n\n        // No positions\n        mockPool.setNumberOfLegs(vault, 0);\n        mockPool.setMockPositionBalanceArray(new uint256[2][](0));\n\n        bytes memory managerInput = createManagerInput(pools, new TokenId[][](1));\n        uint256 nav = accountant.computeNAV(vault, address(underlyingToken), managerInput);\n\n        uint256 expectedNavBase = 1000e18 + net; // Conservative estimate\n        uint256 tolerance = 10e18; // relatively small tolerance for premium conversion calculations\n        assertApproxEqAbs(\n            nav,\n            expectedNavBase,\n            tolerance,\n            \"NAV should include underlying plus converted premiums\"\n        );\n    }\n\n    // ===== helper functions =====\n\n// copy-paste from PanopticVaultAccountant.t.sol\n    function createManagerInput(\n        PanopticVaultAccountant.PoolInfo[] memory pools,\n        TokenId[][] memory tokenIds\n    ) internal pure returns (bytes memory) {\n        PanopticVaultAccountant.ManagerPrices[]\n            memory managerPrices = new PanopticVaultAccountant.ManagerPrices[](pools.length);\n\n        for (uint i = 0; i < pools.length; i++) {\n            managerPrices[i] = PanopticVaultAccountant.ManagerPrices({\n                poolPrice: TWAP_TICK,\n                token0Price: TWAP_TICK,\n                token1Price: TWAP_TICK\n            });\n        }\n\n        return abi.encode(managerPrices, pools, tokenIds);\n    }\n```\n\nAfter the suggested fix is implemented, the test passes.\n\n---\n\n",
    "summary": "\nThe bug report discusses an issue with the `computeNAV()` function in the PanopticVaultAccountant.sol file. This function is responsible for calculating the net asset value (NAV) of a vault by adding up the assets and subtracting the liabilities. The bug causes the `poolExposure1` to be calculated incorrectly, which results in the NAV being incorrect. This means that users may receive more or less shares and assets when deposits or withdrawals are fulfilled. The recommended solution is to fix the calculation of `poolExposure1` to match the calculation of `poolExposure0`. To demonstrate the issue, a test is included in the report that fails when using slightly different values for the premiums. After the suggested fix is implemented, the test passes.",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "18000",
    "contest_link": "https://code4rena.com/reports/2025-06-panoptic-hypovault",
    "sponsor_name": "Panoptic",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-06-panoptic-hypovault",
    "github_link": "https://code4rena.com/audits/2025-06-panoptic-hypovault/submissions/F-69",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "510",
    "slug": "h-01-the-poolexposure-for-token1-is-erroneously-calculated-as-shortpremium-longpremium-code4rena-panoptic-panoptic-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Panoptic",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "0xAura"
            }
        },
        {
            "wardens_warden": {
                "handle": "richa"
            }
        },
        {
            "wardens_warden": {
                "handle": "Neeloy"
            }
        },
        {
            "wardens_warden": {
                "handle": "TheWeb3Mechanic"
            }
        },
        {
            "wardens_warden": {
                "handle": "prk0"
            }
        },
        {
            "wardens_warden": {
                "handle": "Egbe"
            }
        },
        {
            "wardens_warden": {
                "handle": "dan\\_\\_vinci"
            }
        },
        {
            "wardens_warden": {
                "handle": "udogodwin"
            }
        },
        {
            "wardens_warden": {
                "handle": "JuggerNaut63"
            }
        },
        {
            "wardens_warden": {
                "handle": "ro1sharkm"
            }
        },
        {
            "wardens_warden": {
                "handle": "dhank"
            }
        },
        {
            "wardens_warden": {
                "handle": "AlexCzm"
            }
        },
        {
            "wardens_warden": {
                "handle": "Coachmike"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Panoptic",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}