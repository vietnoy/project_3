{
    "id": 62380,
    "kind": "MARKDOWN",
    "auditfirm_id": 34,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 1408,
    "title": "[FNG-17] CErc20InterestMarket collateral can be directly used to pay interest and bypass health check",
    "content": "**Severity:** Critical\n\n**Path:** CErc20InterestMarket.sol:payInterestInternal#L67-L101\n\n**Description:** A CErc20InterestMarket is a CERC20 token that can be used to pay interest for a CERC721 loan. These tokens have USD stable coins as underlying, such as USDC. These tokens are also normal CERC20 tokens and can be used as collateral for loans, so any balance change should be accompanied by a health check.\n\nHowever, the function to pay interest for a CERC721 loan directly takes from the balance of the payer using `payInterestInternal`. If that balance was used as collateral in a loan, then this would bypass the health check completely, making the loan insolvent.\n\nThis provides a way to instantly (in a single transaction) create loans without any collateral backing it, creating large bad debt for the protocol.\n\nFor example:\n\n1. A user has a loan for an ERC721 worth 100 ETH.\n\n2. After some time, the user racks up 10 ETH worth in interest for that loan.\n\n3. The user now uses a second account to create a new loan using 10 ETH worth of USDC as collateral and borrowing as much as possible (e.g. 8.5 ETH worth of DAI).\n\n4. The user now calls `CErc721:repayBorrowBehalf`, which will call `CErc20InterestMarket:payInterestInternal` and pay the interest using the collateral balance of the second account, bypassing the health check.\n\n5. In the end, only 1.5 ETH was paid back instead of the 10 ETH and an 8.5 ETH bad debt loan has been created.\n```\nfunction payInterestInternal(address borrowMarket, address payer, uint interestAmount) internal {\n    if (interestAmount == 0) {\n        return;\n    }\n\n    /* Fail if pay interest not allowed */\n    uint allowed = comptroller.payInterestAllowed(address(this), borrowMarket, payer, interestAmount);\n    require(allowed == 0, \"pay not allowed\");\n\n    Exp memory exchangeRate = Exp({mantissa: exchangeRateStoredInternal()});\n    uint interestTokens = div_(interestAmount, exchangeRate);\n\n    // payer interest market balance is reduced to cover interest being paid\n    uint balancePayer = accountTokens[payer];\n    require(balancePayer >= interestTokens, \"insufficient payer reserve\");\n    accountTokens[payer] = balancePayer - interestTokens;\n    emit Transfer(payer, address(0), interestTokens);\n\n    uint totalVirtual_ = totalVirtual;\n    uint heldBalance;\n    if (interestTokens > totalVirtual_) {\n        heldBalance = interestTokens - totalVirtual_;\n        totalSupply = totalSupply - totalVirtual_;\n        totalVirtual = 0;\n    } else {\n        totalSupply = totalSupply - interestTokens;\n        totalVirtual = totalVirtual_ - interestTokens;\n    }\n\n    if (heldBalance != 0) {\n        // keep a reserve of cToken\n        accountTokens[address(this)] = accountTokens[address(this)] + heldBalance;\n        emit Transfer(address(0), address(this), heldBalance);\n    }\n}\n```\n**Remediation:**  The function `payInterestInternal` should do a check by calling to `Comptroller.isRedeemAllowed` for the `payer` and the payment amount in a `require` statement. Similar to the `redeem` function.\n\n**Status:**  Fixed\n\n- - -",
    "summary": "\nThe bug report is about a critical issue in the code for a CErc20InterestMarket, which is a type of token used for paying interest on loans. The problem is that the function responsible for paying interest does not properly check if the payer has enough collateral to cover the payment. This means that someone could create a loan without any collateral and cause a large amount of bad debt for the protocol. The issue has been fixed by implementing a check similar to the one used in the `redeem` function.",
    "report_date": "2023-11-06T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/solodit/solodit_content/blob/main/reports/Hexens/2023-11-06-Fungify.md",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "fng-17-cerc20interestmarket-collateral-can-be-directly-used-to-pay-interest-and-bypass-health-check-hexens-none-fungify-markdown",
    "firm_name": "Hexens",
    "firm_logo_square": "Hexens_square.png",
    "protocol_name": "Fungify",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Hexens"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Hexens",
        "logo_square": "Hexens_square.png"
    },
    "protocols_protocol": {
        "name": "Fungify",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}