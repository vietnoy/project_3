{
    "id": 62730,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "MEDIUM",
    "finders_count": 56,
    "protocol_id": 3324,
    "title": "M-7: Incorrect transfer size validation after time window reset can lead to rebalancing DoS",
    "content": "\nSource: https://github.com/sherlock-audit/2025-07-malda-judging/issues/234 \n\n## Found by \n0x213, 0xBlackie, 0xEkko, 0xShoonya, 0xSolus, 0xapple, 0xmechanic, 10ap17, 5am, 7, 8olidity, BADROBINX, Bizarro, Cybrid, DeveloperX, EQUATION, HeckerTrieuTien, Ivcho332, KiroBrejka, LeFy, MacroWang, PratRed, RaiseUp, Sparrow\\_Jac, WillyCode20, Yaneca\\_b, ZanyBonzy, Ziusz, axelot, coin2own, dan\\_\\_vinci, davies0212, djshaneden, dreamcoder, elolpuer, elyas, farismaulana, gh0xt, har0507, harry, magbeans9, mahdifa, maxim371, onudasatoshi, oxelmiguel, oxwhite, pollersan, sheep, softdev0323, swarun, teoslaf1, v10g1, vangrim, who\\_is\\_rp, yoooo, zach223\n\n### Summary\n\nUsing stale `TransferInfo` in the `Rebalancer::sendMsg` function will cause a false `Rebalancer_TransferSizeExcedeed` revert for EOA rebalancers as in normal use flow, the contract checks the old transfer size even after resetting it for a new time window, leading to unexpected reverts and potential disruption of rebalancing operations.\n\n```solidity\n       TransferInfo memory transferInfo = currentTransferSize[_msg.dstChainId][_msg.token];\n        uint256 transferSizeDeadline = transferInfo.timestamp + transferTimeWindow;\n        if (transferSizeDeadline < block.timestamp) {\n            currentTransferSize[_msg.dstChainId][_msg.token] = TransferInfo(_amount, block.timestamp);\n        } else {\n            currentTransferSize[_msg.dstChainId][_msg.token].size += _amount;\n        }\n\n        uint256 _maxTransferSize = maxTransferSizes[_msg.dstChainId][_msg.token];\n        if (_maxTransferSize > 0) {\n            require(transferInfo.size + _amount < _maxTransferSize, Rebalancer_TransferSizeExcedeed());\n            //@audit if `transferSizeDeadline < block.timestamp` than `transferInfo` won't be updated but we changed `currentTransferSize` to be `TransferInfo(_amount, block.timestamp)` so we will check using the old transfer size + amount instead in this case using only amount which will lead to unexpected DoS\n        }\n```\n\n### Root Cause\n\nIn `Rebalancer.sol`, the `sendMsg` function resets `currentTransferSize[_msg.dstChainId][_msg.token]` to `TransferInfo(_amount, block.timestamp)` when the time window expires, but still uses the old `transferInfo.size` for the max transfer size check (`require(transferInfo.size + _amount < _maxTransferSize)`), causing incorrect validation and potential DoS.\n\nhttps://github.com/sherlock-audit/2025-07-malda/blob/main/malda-lending/src/rebalancer/Rebalancer.sol#L141-L152\n\n### Internal Pre-conditions\n\n1. In normal use, an authorized rebalancer performs transfers that bring the recorded `currentTransferSize` close to the maximum allowed for a token and destination chain within the current time window.\n2. Once the time window expires, the next transfer resets `currentTransferSize` to the new transfer amount with an updated timestamp.\n3. However, during this next transfer, the contract still checks the sum of the old (stale) transfer size plus the new amount against the max limit, causing an unexpected revert and blocking valid transfers.\n\n### External Pre-conditions\n\nnone\n\n### Attack Path\n\n1. An authorized rebalancer calls `sendMsg` multiple times within a single `transferTimeWindow`, pushing `currentTransferSize[_dstChainId][_token].size` close to `maxTransferSizes[_dstChainId][_token]`.\n2. The `transferTimeWindow` expires without further transfers, so `currentTransferSize[_dstChainId][_token]` remains at a high value but stale.\n3. On the first `sendMsg` call after the window resets, the contract resets `currentTransferSize` to the new amount but still validates using the old (stale) `transferInfo.size`.\n4. Because the validation uses the stale size, the contract rejects the transfer by reverting with `Rebalancer_TransferSizeExcedeed`, even though the new window should allow it.\n5. This causes a denial of service for rebalancing operations on that token and destination chain until the next window reset or state update.\n\n### Impact\n\nThe authorized rebalancers cannot execute valid rebalancing transfers for certain tokens and destination chains immediately after a transfer time window resets. This causes a denial of service in normal use flow, disrupting expected protocol operations without any malicious actor involved.\n\n### PoC\n\n_No response_\n\n### Mitigation\n\n_No response_\n\n## Discussion\n\n**sherlock-admin2**\n\nThe protocol team fixed this issue in the following PRs/commits:\nhttps://github.com/malda-protocol/malda-lending/pull/138\n\n\n**CergyK**\n\nFix looks good\n\n\n\n",
    "summary": "\nThe bug report is about an issue found in the code of a decentralized finance (DeFi) project called Malda. The issue was discovered by a group of people and reported on GitHub. The bug can cause a disruption in the rebalancing operations of the project, which can affect the functionality of the protocol. It is caused by using old information in a specific function, leading to incorrect validation and potential denial of service. The team behind the project has fixed the issue and the fix has been reviewed and approved by the community.",
    "report_date": "2025-08-14T17:00:00.000Z",
    "contest_prize_txt": "80000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1029",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-07-malda-judging/issues/234",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1029",
    "slug": "m-7-incorrect-transfer-size-validation-after-time-window-reset-can-lead-to-rebalancing-dos-sherlock-malda-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "Malda",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "dreamcoder"
            }
        },
        {
            "wardens_warden": {
                "handle": "HeckerTrieuTien"
            }
        },
        {
            "wardens_warden": {
                "handle": "axelot"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xSolus"
            }
        },
        {
            "wardens_warden": {
                "handle": "djshaneden"
            }
        },
        {
            "wardens_warden": {
                "handle": "onudasatoshi"
            }
        },
        {
            "wardens_warden": {
                "handle": "har0507"
            }
        },
        {
            "wardens_warden": {
                "handle": "oxwhite"
            }
        },
        {
            "wardens_warden": {
                "handle": "EQUATION"
            }
        },
        {
            "wardens_warden": {
                "handle": "ZanyBonzy"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xShoonya"
            }
        },
        {
            "wardens_warden": {
                "handle": "elolpuer"
            }
        },
        {
            "wardens_warden": {
                "handle": "dan\\_\\_vinci"
            }
        },
        {
            "wardens_warden": {
                "handle": "Ivcho332"
            }
        },
        {
            "wardens_warden": {
                "handle": "10ap17"
            }
        },
        {
            "wardens_warden": {
                "handle": "yoooo"
            }
        },
        {
            "wardens_warden": {
                "handle": "5am"
            }
        },
        {
            "wardens_warden": {
                "handle": "who\\_is\\_rp"
            }
        },
        {
            "wardens_warden": {
                "handle": "farismaulana"
            }
        },
        {
            "wardens_warden": {
                "handle": "sheep"
            }
        },
        {
            "wardens_warden": {
                "handle": "DeveloperX"
            }
        },
        {
            "wardens_warden": {
                "handle": "elyas"
            }
        },
        {
            "wardens_warden": {
                "handle": "7"
            }
        },
        {
            "wardens_warden": {
                "handle": "davies0212"
            }
        },
        {
            "wardens_warden": {
                "handle": "WillyCode20"
            }
        },
        {
            "wardens_warden": {
                "handle": "Bizarro"
            }
        },
        {
            "wardens_warden": {
                "handle": "pollersan"
            }
        },
        {
            "wardens_warden": {
                "handle": "KiroBrejka"
            }
        },
        {
            "wardens_warden": {
                "handle": "LeFy"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xEkko"
            }
        },
        {
            "wardens_warden": {
                "handle": "v10g1"
            }
        },
        {
            "wardens_warden": {
                "handle": "dan\\_\\_vinci"
            }
        },
        {
            "wardens_warden": {
                "handle": "BADROBINX"
            }
        },
        {
            "wardens_warden": {
                "handle": "swarun"
            }
        },
        {
            "wardens_warden": {
                "handle": "Yaneca\\_b"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xmechanic"
            }
        },
        {
            "wardens_warden": {
                "handle": "8olidity"
            }
        },
        {
            "wardens_warden": {
                "handle": "harry"
            }
        },
        {
            "wardens_warden": {
                "handle": "PratRed"
            }
        },
        {
            "wardens_warden": {
                "handle": "oxelmiguel"
            }
        },
        {
            "wardens_warden": {
                "handle": "mahdifa"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xapple"
            }
        },
        {
            "wardens_warden": {
                "handle": "Cybrid"
            }
        },
        {
            "wardens_warden": {
                "handle": "teoslaf1"
            }
        },
        {
            "wardens_warden": {
                "handle": "softdev0323"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xBlackie"
            }
        },
        {
            "wardens_warden": {
                "handle": "zach223"
            }
        },
        {
            "wardens_warden": {
                "handle": "Sparrow\\_Jac"
            }
        },
        {
            "wardens_warden": {
                "handle": "MacroWang"
            }
        },
        {
            "wardens_warden": {
                "handle": "RaiseUp"
            }
        },
        {
            "wardens_warden": {
                "handle": "0x213"
            }
        },
        {
            "wardens_warden": {
                "handle": "coin2own"
            }
        },
        {
            "wardens_warden": {
                "handle": "Ziusz"
            }
        },
        {
            "wardens_warden": {
                "handle": "maxim371"
            }
        },
        {
            "wardens_warden": {
                "handle": "vangrim"
            }
        },
        {
            "wardens_warden": {
                "handle": "magbeans9"
            }
        },
        {
            "wardens_warden": {
                "handle": "gh0xt"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "Malda",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}