{
    "id": 62076,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "MEDIUM",
    "finders_count": 4,
    "protocol_id": 2159,
    "title": "[M-13] Missing reserve interest accrual prior to backstop take rate update leads to incorrect `backstop_credit` computation",
    "content": "\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/config.rs# L51>\n\n### Summary\n\nReserve interest is not updated when `bstop_rate` is changed. Because `bstop_rate` determines the percentage of the accrued interest that will be stored as backstop credit, not accruing the reserve prior to changing the `bstop_rate` will make previous unaccrued assets too.\n\n### Vulnerability details\n\nWhen loading a reserve and accruing interest, some of the `accrued_interest` is stored as backstop credit, which will later be auctioned via an interest auction. The amount of interest going to the backstop credit is determined by the `bstop_rate`, which is configured as a percentage for the reserve in question, and computed as `accrued.fixed_mul_floor(e, &i128(bstop_rate), &SCALAR_7);`:\n```\n\n// File: reserve.rs\n\npub fn load(e: &Env, pool_config: &PoolConfig, asset: &Address) -> Reserve {\n        ...\n\n        reserve.accrue(e, pool_config.bstop_rate, accrued_interest);\n\n        reserve.data.last_time = e.ledger().timestamp();\n        reserve\n    }\n\n fn accrue(&mut self, e: &Env, bstop_rate: u32, accrued: i128) {\n        let pre_update_supply = self.total_supply(e);\n\n        if accrued > 0 {\n            let mut new_backstop_credit: i128 = 0;\n            if bstop_rate > 0 {\n                new_backstop_credit = accrued.fixed_mul_floor(e, &i128(bstop_rate), &SCALAR_7);\n                self.data.backstop_credit += new_backstop_credit;\n            }\n\n            self.data.b_rate = (pre_update_supply + accrued - new_backstop_credit).fixed_div_floor(\n                e,\n                &self.data.b_supply,\n                &SCALAR_12,\n            );\n        }\n    }\n```\n\n`bstop_rate` can be updated for a specific reserve by calling `execute_update_pool():`\n```\n\n// File: config.rs\n\npub fn execute_update_pool(\n    e: &Env,\n    backstop_take_rate: u32,\n    max_positions: u32,\n    min_collateral: i128,\n) {\n    let mut pool_config = storage::get_pool_config(e);\n    pool_config.bstop_rate = backstop_take_rate;\n\n    ...\n}\n```\n\nThe problem is that updating the `bstop_rate` does not accrue interest for the reserve. This can lead to the following situation:\n\n1. A pool has a total of 100 tokens of a given reserve to be accrued as `accrued_interest`. The current `bstop_rate` is configured to 30%, so 30 tokens should be stored as `backstop_credit` for the corresponding period.\n2. The admin of the pool triggers a pool update in order to change the `bstop_rate` from 30% to 0%. Note there’s still not been any accrual in the reserve (this can be due to low interactions in the pool, for example), and the pool updating logic doesn’t accrue interest for the reserve either. This effectively directly sets the `bstop_rate` to 0%.\n3. After changing the `bstop_rate`, an interaction is performed in the pool, and the interest of the reserve is accrued. However, because `bstop_rate` was changed, a 0% of the 100 accrued will be directed to the `backstop_credit`, although a 30% should have been directed to it, as the 100 tokens were accrued while the backstop rate config was set to 30%.\n\n### Impact\n\nMedium. If `bstop_rate` changes, the amount of interest allocated to `backstop_credit` can be miscalculated. This issue is most likely to occur in pools with lower activity, where the longer intervals between interactions allow unaccounted rewards to accumulate. In contrast, pools with higher activity face a reduced risk, as interest accrues with each interaction that triggers one of the main flows.\n\n### Recommended mitigation steps\n\nConsider loading the reserve and storing it so that interest is accrued prior to updating the `bstop_rate`. This will make the old `bstop_rate` value be used to compute the corresponding interest.\n\n**markus\\_pl10 (Script3) confirmed**\n\n**[mootz12 (Script3) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-60?commentParent=ifeB5k54ysy):**\n\n> Fixed [here](https://github.com/blend-capital/blend-contracts-v2/pull/49/commits/b3e5af40dd5cd9fda7f1dd2ca33926672813c73f) to update reserves when backstop take rate changes.\n\n**[Blend mitigated](https://github.com/code-423n4/2025-04-blend-mitigation?tab=readme-ov-file# mitigation-of-high--medium-severity-issues):**\n\n> [Commit b3e5af4](https://github.com/blend-capital/blend-contracts-v2/pull/49/commits/b3e5af40dd5cd9fda7f1dd2ca33926672813c73f) to improve pool config admin functions.\n\n**Status:** Mitigation confirmed. Full details in reports from [Testerbot](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-76), [oakcobalt](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-31), [0xAlix2](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-5) and [0x007](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-61).\n\n---\n\n",
    "summary": "\nThe bug report is about an issue in the code for a reserve in a pool. When the `bstop_rate` (which determines how much of the accrued interest is stored as backstop credit) is changed, the interest for the reserve is not updated. This can lead to a miscalculation in the amount of interest allocated to the backstop credit. The impact is considered medium and the recommended mitigation is to load and store the reserve before updating the `bstop_rate`. The issue has been confirmed and mitigated by the developers.",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "125000",
    "contest_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "sponsor_name": "Blend",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "github_link": "https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-60",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "492",
    "slug": "m-13-missing-reserve-interest-accrual-prior-to-backstop-take-rate-update-leads-to-incorrect-backstop_credit-computation-code4rena-blend-blend-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Blend",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Testerbot"
            }
        },
        {
            "wardens_warden": {
                "handle": "Tigerfrake"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xadrii"
            }
        },
        {
            "wardens_warden": {
                "handle": "oakcobalt"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Blend",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}