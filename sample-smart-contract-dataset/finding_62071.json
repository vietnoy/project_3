{
    "id": 62071,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "MEDIUM",
    "finders_count": 5,
    "protocol_id": 2159,
    "title": "[M-08] Removing a pool from the reward zone leads to the loss of ungulped emissions",
    "content": "\n\n<https://github.com/code-423n4/2025-02-blend/blob/main/blend-contracts-v2/backstop/src/emissions/manager.rs# L66-L78>\n\n### Finding description and impact\n\nPools enter the reward zone in the backstop module to search emissions. When distribution happens, the global reward zone index is updated. Later, when changes happen to different pools, the pool reward zone index is updated to account for the newly distributed emissions. Each pool takes its part and adds it to the `accrued` balance until gulped later.\n\nOn the other hand, pools could be removed from the reward zone, if the pool’s backstop balance falls below a certain threshold. When a pool is removed, `remove_from_reward_zone` is called, which also calls `remove_pool`, which in turn removes the pool from the reward zone array, and sets the pool’s reward zone index to infinity.\n\n<https://github.com/code-423n4/2025-02-blend/blob/main/blend-contracts-v2/backstop/src/emissions/manager.rs# L92-L95>\n```\n\nlet to_remove_emis_data = storage::get_rz_emis_data(e, &to_remove).unwrap_optimized();\nset_rz_emissions(e, &to_remove, i128::MAX, to_remove_emis_data.accrued, false);\n\nreward_zone.remove(idx);\n```\n\nHowever, this doesn’t account for the unaccrued pool’s emissions, forcing them to be lost, in other words, `update_rz_emis_data` is not called to account for those emissions.\n\nFor example, if a distribution is made, and without any pool balance changes happen, the pool is removed. The pool’s part of the last emission is lost, and can never be claimed.\n\n### Proof of Concept\n\nAdd the following test to `blend-contracts-v2/backstop/src/emissions/manager.rs`:\n```\n\n#[test]\nfn test_removed_rz_pool_loses_emissions() {\n    let e = Env::default();\n    e.ledger().set(LedgerInfo {\n        timestamp: 1713139200,\n        protocol_version: 22,\n        sequence_number: 0,\n        network_id: Default::default(),\n        base_reserve: 10,\n        min_temp_entry_ttl: 10,\n        min_persistent_entry_ttl: 10,\n        max_entry_ttl: 3110400,\n    });\n    e.mock_all_auths();\n\n    let bombadil = Address::generate(&e);\n    let backstop_id = create_backstop(&e);\n    let pool_1 = Address::generate(&e);\n    let pool_2 = Address::generate(&e);\n\n    let (blnd_id, _) = create_blnd_token(&e, &backstop_id, &bombadil);\n    let (usdc_id, _) = create_usdc_token(&e, &backstop_id, &bombadil);\n    create_comet_lp_pool_with_tokens_per_share(\n        &e,\n        &backstop_id,\n        &bombadil,\n        &blnd_id,\n        5_0000000,\n        &usdc_id,\n        0_1000000,\n    );\n\n    let reward_zone: Vec<Address> = vec![&e, pool_1.clone(), pool_2.clone()];\n\n    e.as_contract(&backstop_id, || {\n        storage::set_reward_zone(&e, &reward_zone);\n        storage::set_last_distribution_time(&e, &(1713139200 - 1 * 24 * 60 * 60));\n\n        // Set up balances for both pools\n        storage::set_pool_balance(\n            &e,\n            &pool_1,\n            &PoolBalance {\n                shares: 90_000_0000000,\n                tokens: 100_001_0000000,\n                q4w: 1_000_0000000,\n            },\n        );\n        // non-queued tokens are 0\n        storage::set_pool_balance(\n            &e,\n            &pool_2,\n            &PoolBalance {\n                shares: 35_000_0000000,\n                tokens: 40_000_0000000,\n                q4w: 30_000_0000000,\n            },\n        );\n\n        // Set emissions indexes\n        storage::set_rz_emission_index(&e, &SCALAR_7);\n        storage::set_rz_emis_data(\n            &e,\n            &pool_1,\n            &RzEmissionData {\n                index: SCALAR_7,\n                accrued: 0,\n            },\n        );\n        storage::set_rz_emis_data(\n            &e,\n            &pool_2,\n            &RzEmissionData {\n                index: SCALAR_7,\n                accrued: 0,\n            },\n        );\n\n        let mut pool_1_emis = storage::get_rz_emis_data(&e, &pool_1).unwrap_optimized();\n        let mut pool_2_emis = storage::get_rz_emis_data(&e, &pool_2).unwrap_optimized();\n\n        // Global index is set as initial index\n        assert_eq!(storage::get_rz_emission_index(&e), SCALAR_7);\n\n        // Pools 1 and 2 have initial index\n        assert_eq!(pool_1_emis.index, SCALAR_7);\n        assert_eq!(pool_2_emis.index, SCALAR_7);\n\n        // No accrued emissions\n        assert_eq!(pool_1_emis.accrued, 0);\n        assert_eq!(pool_2_emis.accrued, 0);\n\n        // Call `distribute` to distribute emissions\n        distribute(&e);\n\n        pool_1_emis = storage::get_rz_emis_data(&e, &pool_1).unwrap_optimized();\n        pool_2_emis = storage::get_rz_emis_data(&e, &pool_2).unwrap_optimized();\n\n        // Global index is updated, i.e. each pool has a part of the emissions\n        assert_eq!(storage::get_rz_emission_index(&e), 8_259_710_4719394);\n\n        // Pools 1 and 2 haven't accrued any emissions\n        assert_eq!(pool_1_emis.accrued, 0);\n        assert_eq!(pool_2_emis.accrued, 0);\n\n        // Remove `pool_2` from the reward zone\n        remove_from_reward_zone(&e, pool_2.clone());\n\n        // Validate that pool_2 has been removed\n        assert_eq!(storage::get_reward_zone(&e), vec![&e, pool_1.clone()]);\n\n        pool_1_emis = storage::get_rz_emis_data(&e, &pool_1).unwrap_optimized();\n        pool_2_emis = storage::get_rz_emis_data(&e, &pool_2).unwrap_optimized();\n\n        // Pool 1 has initial index\n        assert_eq!(storage::get_rz_emission_index(&e), 8_259_710_4719394);\n\n        // Pool 1 has initial index\n        assert_eq!(pool_1_emis.index, SCALAR_7);\n        // Pool 2 has been removed and has an index of i128::MAX\n        assert_eq!(pool_2_emis.index, i128::MAX);\n\n        // Pool 2 has no accrued emissions, even though the index is i128::MAX\n        assert_eq!(pool_2_emis.accrued, 0);\n    });\n}\n```\n\n### Recommended mitigation steps\n\nAccrue the emissions of the removed pool, before setting its rewards index to infinity.\n```\n\n    /// remove a pool to the reward zone if below the minimum backstop deposit threshold\n    pub fn remove_from_reward_zone(e: &Env, to_remove: Address) {\n        let mut reward_zone = storage::get_reward_zone(e);\n\n        // ensure to_add has met the minimum backstop deposit threshold\n        // NOTE: \"to_add\" can only carry a pool balance if it is a deployed pool from the factory\n        let pool_data = load_pool_backstop_data(e, &to_remove);\n        if require_pool_above_threshold(&pool_data) {\n            panic_with_error!(e, BackstopError::BadRequest);\n        } else {\n+           update_rz_emis_data(e, &to_remove, false);\n            remove_pool(e, &mut reward_zone, &to_remove);\n            storage::set_reward_zone(e, &reward_zone);\n        }\n    }\n```\n\n**markus\\_pl10 (Script3) disputed**\n\n**[mootz12 (Script3) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-25?commentParent=K5FhTZSytHM):**\n\n> This is not a finding.\n>\n> Removing pools is safeguarded by a check to ensure distribution was called fairly recently, to limit the lost emissions for removed pools.\n>\n> This is not a common code pathway, and losing a day of emissions is not considered vital, due to the complications of forcing distribute to be invoked during removal with resource limitations.\n>\n> However, documentation should be added to ensure that is clear.\n\n**[LSDan (judge) commented](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-25?commentParent=K5FhTZSytHM&commentChild=Abab6DyJ7SA):**\n\n> I disagree. This locks funds and causes a loss of emissions. Medium is appropriate here, per [the docs](https://docs.code4rena.com/awarding/judging-criteria/supreme-court-decisions-fall-2023# verdict-loss-of-yield-as-high).\n\n**[Blend mitigated](https://github.com/code-423n4/2025-04-blend-mitigation?tab=readme-ov-file# mitigation-of-high--medium-severity-issues):**\n\n> [Commit 6204dba](https://github.com/blend-capital/blend-contracts-v2/commit/6204dba1f935240a06f130026f3bf850c99a665d) to improve reward zone changes emissions impact.\n\n**Status:** Mitigation confirmed. Full details in reports from [oakcobalt](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-29), [0xAlix2](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-9), [0x007](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-50) and [Testerbot](https://code4rena.com/audits/2025-04-blend-v2-mitigation-review/submissions/S-70).\n\n---\n\n",
    "summary": "\nThis bug report discusses an issue with the backstop module in the Blend contract. The problem occurs when a pool is removed from the reward zone due to its balance falling below a certain threshold. This removal process does not account for any unaccrued emissions, resulting in those emissions being lost. This can happen if a distribution is made and a pool is removed without any balance changes. A proof of concept test is provided to demonstrate this issue. The recommended mitigation steps include accruing the emissions of the removed pool before setting its rewards index to infinity. The report also includes comments from the community and the project team's response, including a link to the commit that addresses the issue. The status of the mitigation is confirmed.",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "125000",
    "contest_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "sponsor_name": "Blend",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "github_link": "https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-25",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "492",
    "slug": "m-08-removing-a-pool-from-the-reward-zone-leads-to-the-loss-of-ungulped-emissions-code4rena-blend-blend-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Blend",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "carrotsmuggler"
            }
        },
        {
            "wardens_warden": {
                "handle": "oakcobalt"
            }
        },
        {
            "wardens_warden": {
                "handle": "Testerbot"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xadrii"
            }
        },
        {
            "wardens_warden": {
                "handle": "0xAlix2"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Blend",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}