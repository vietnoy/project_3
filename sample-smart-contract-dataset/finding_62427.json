{
    "id": 62427,
    "kind": "MARKDOWN",
    "auditfirm_id": 34,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 3407,
    "title": "[ZLS1-2] First Depositor Can Front-Run and Steal the Next User's Stake",
    "content": "**Severity:** High\n\n**Path:** contracts/ZEALInfinityPool.sol#L196-L197\ncontracts/ZEALInfinityPool.sol#L274-L287  \n\n**Description:** The `ZEALInfinityPool.stake()` function mints xZeal shares in exchange for Zeal tokens. The number of shares minted is calculated as follows:\n```\n1. currentRate = (totalStaked + totalRewards).mulDiv(PRECISION_FACTOR, xSupply);\n2. xMint = _amount.mulDiv(PRECISION_FACTOR, currentRate);\n```\nSince the calculation uses rounding down, `xMint` will be zero if `_amount * PRECISION_FACTOR < currentRate`. An attacker can exploit this by inflating the exchange rate using the `addRewards() `function, effectively making the next user's stake lose half of value.\n\nExploit Scenario (Assuming `zealPerBlock = 0`)\n1. Initial Stake:\n\n    - The attacker stakes `minStakeAmount`, receiving the same amount in xZeal.\n\n    - State:\n\n        - `totalStaked = minStakeAmount`\n\n        - `xZeal.totalSupply() = minStakeAmount`\n\n        - `getExchangeRate() = 1e18`\n\n2. Partial Unstake:\n\n    - The attacker unstakes `minStakeAmount - 1` xZeal.\n\n    - State:\n\n        - `totalStaked = 1`\n\n        - `xZeal.totalSupply() = 1`\n\n        - `getExchangeRate = 1e18`\n\n3. Victim Prepares to Stake:\n\n    - Alice (a regular user) submits a transaction to stake `X` Zeal.\n\n4. Front-Run with Rewards:\n\n    - The attacker front-runs Alice by calling addRewards(X / 2).\n\n    - This increases `totalStaked` without changing `xZeal.totalSupply`, causing the exchange rate to spike.\n\n    - State:\n\n        - `totalStaked = 1 + X / 2`\n\n        - `xZeal.totalSupply() = 1`\n\n        - `getExchangeRate() = (1 + X / 2) * 1e18`\n\n5. Alice's Stake Executes:\n\n    - Alice’s minted shares:\n\n        `xMint = X * 1e18 / ((1 + X / 2) * 1e18) = X / (1 + X / 2)`\n\n        - Due to rounding, `xMint = 1`\n\nOutcome:\nThe attacker eventually calls `unstake()` to reclaim their Zeal tokens, they will receive:\n```\n    (X + 1 + X / 2) / 2 \n  = (X / 2 + 1) + (X / 4 - 0.5)\n```\nHere:\n\n- `(X / 2 + 1) `represents the attacker’s initial investment in the strategy.\n\n- `(X / 4 - 0.5)` is the net profit gained from front-running and draining the next user’s stake.\n```\nuint256 xMint = _amount.mulDiv(PRECISION_FACTOR, currentRate);\nrequire(xMint > 0, \"Stake amount too small\");\n```\n```\ntotalRewards += _amount;\ntotalManualRewards += _amount;\n\nuint256 xSupply = xZealToken.totalSupply();\nuint256 newRate;\n\nif (xSupply == 0) {\n    newRate = currentRate;\n} else {\n    newRate = (totalStaked + totalRewards).mulDiv(\n        PRECISION_FACTOR,\n        xSupply\n    );\n}\n```\n\n**Remediation:**  Consider burning an initial amount of xZeal tokens (representing dead shares), similar to the approach used in the `ZealousSwapPair` contract.\n\n**Status:**  Fixed\n\n\n- - -",
    "summary": "\nThe report describes a bug in the `ZEALInfinityPool` contract where the `stake()` function can be exploited by an attacker to manipulate the exchange rate and steal funds from other users. The bug occurs due to a rounding error in the calculation of the number of shares minted, which can result in the value being rounded down to zero. The attacker can take advantage of this by artificially inflating the exchange rate using the `addRewards()` function, causing the next user's stake to lose half of its value. This can lead to the attacker making a profit at the expense of other users. The report suggests a potential fix for this issue by burning a certain amount of xZeal tokens, similar to a strategy used in another contract. The bug has been fixed by the developers.",
    "report_date": "2025-05-26T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/solodit/solodit_content/blob/main/reports/Hexens/2025-05-26-Zealous.md",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "zls1-2-first-depositor-can-front-run-and-steal-the-next-users-stake-hexens-none-zealous-markdown",
    "firm_name": "Hexens",
    "firm_logo_square": "Hexens_square.png",
    "protocol_name": "Zealous",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Hexens"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Hexens",
        "logo_square": "Hexens_square.png"
    },
    "protocols_protocol": {
        "name": "Zealous",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}