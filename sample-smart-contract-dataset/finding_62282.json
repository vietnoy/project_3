{
    "id": 62282,
    "kind": "PDF",
    "auditfirm_id": 6,
    "impact": "HIGH",
    "finders_count": 3,
    "protocol_id": 3396,
    "title": "DoSing vault rehypothecation through flashloans",
    "content": "## Security Report\n\n## Severity: High Risk\n\n### Context\n`AToken.sol#L388`\n\n### Description\nDuring a flash loan, the AToken contract transfers the underlying amount to the user through the `transferUnderlyingTo` function, which withdraws tokens from the vault when using it:\n\n```solidity\nfunction transferUnderlyingTo(address target, uint256 amount)\n    external\n    override\n    onlyLendingPool\n    returns (uint256)\n{\n    _rebalance(amount);\n    _underlyingAmount = _underlyingAmount - amount;\n    IERC20(_underlyingAsset).safeTransfer(target, amount);\n    return amount;\n}\n```\n\nAfter executing the receiver logic, the underlying tokens are transferred back to the AToken contract, but the rebalance is not triggered. This could lead to a situation where the vault is left without tokens, causing a DOS in vault rehypothecation:\n\n```solidity\nfunction handleRepayment(address user, address onBehalfOf, uint256 amount)\n    external\n    override\n    onlyLendingPool\n{\n    _underlyingAmount = _underlyingAmount + amount;\n}\n```\n\nA full fuzzing test was provided by Cod3x team and can be found in the echidna branch.\n\n### Recommendation\nConsider calling the `_rebalance` function exclusively during flashloan operations, since triggering `_rebalance` during liquidation or repayment flows may cause another DOS if the vault is paused or has reached its deposit cap.\n\n### Audits\n- **Astera:** Fixed in commit `4605e906`.\n- **Spearbit:** Fix verified.",
    "summary": "\nThis bug report is about a high-risk security issue in the AToken contract which is used for flash loans. During a flash loan, the contract transfers tokens to the user through a function called `transferUnderlyingTo`. However, after the tokens are transferred back to the contract, a function called `_rebalance` is not triggered, which could lead to a situation where the vault is left without tokens. This could cause a denial of service (DOS) attack on the vault. The report recommends calling the `_rebalance` function only during flash loan operations to prevent this issue. The bug has been fixed by the Astera team and verified by the Spearbit team.",
    "report_date": "2025-08-29T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Astera-Spearbit-Security-Review-December-2024.pdf",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Astera-Spearbit-Security-Review-December-2024.pdf",
    "github_link": "",
    "pdf_link": "https://solodit-bucket.s3.amazonaws.com/storage/reports/spearbit/Astera-Spearbit-Security-Review-December-2024.pdf",
    "pdf_page_from": 16,
    "contest_id": "",
    "slug": "dosing-vault-rehypothecation-through-flashloans-spearbit-none-astera-pdf",
    "firm_name": "Spearbit",
    "firm_logo_square": "spearbit_square.png",
    "protocol_name": "Astera",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Saw-mon and Natalie"
            }
        },
        {
            "wardens_warden": {
                "handle": "Cergyk"
            }
        },
        {
            "wardens_warden": {
                "handle": "Jonatas Martins"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Spearbit",
        "logo_square": "spearbit_square.png"
    },
    "protocols_protocol": {
        "name": "Astera",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}