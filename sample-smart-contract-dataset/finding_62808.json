{
    "id": 62808,
    "kind": "GIT",
    "auditfirm_id": 3,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 3398,
    "title": "H-1: Gas consumed in `notifyUnsubscribe` is underestimated during tests and is greater than 300,000 without pre-warming",
    "content": "\nSource: https://github.com/sherlock-audit/2025-09-bmx-deli-swap-judging/issues/27 \n\n## Found by \ncergyk\n\n### Description\n\nTo protect users against bricked positions by malicious subscriber contracts, `Uniswap V4` notifier allows recovery of a reverting `notifyUnsubscribe` call:\n\n[Notifier.sol#L80-L86](https://github.com/Uniswap/v4-periphery/blob/60cd93803ac2b7fa65fd6cd351fd5fd4cc8c9db5/src/base/Notifier.sol#L80-L86):\n```solidity\n    if (address(_subscriber).code.length > 0) {\n        // require that the remaining gas is sufficient to notify the subscriber\n        // otherwise, users can select a gas limit where .notifyUnsubscribe hits OutOfGas yet the\n        // transaction/unsubscription can still succeed\n        if (gasleft() < unsubscribeGasLimit) GasLimitTooLow.selector.revertWith();\n        //@audit try/catch to protect against malicious _subscriber\n        try _subscriber.notifyUnsubscribe{gas: unsubscribeGasLimit}(tokenId) {} catch {}\n    }\n```\n\nConversely, in order to protect `subscriber` against forced failure due to insufficient user gas limit, outer call reverts if less than `unsubscribeGasLimit` is available, and thus guarantees at least `(unsubscribeGasLimit*63)/64` is provided to `notifyUnsubscribe` call (the `63/64` factor is due to EIP 150).\n\n`unsubscribeGasLimit` value on Base is set to `300,000`.\n\nThis is why `PositionManagerAdapter.notifyUnsubscribe` must keep gas cost under `(300,000*63)/64 ~= 295000`, to avoid users unsubscribing successfully on `Uniswap V4` while leaving positions with liquidity in Deli gauges accounting.\n\nUnfortunately, this is not the case, and the call to `notifyUnsubscribe` can consume more than `300,000` gas, as shown in the POC below.\n\n### Impact\nUsers can force unsubscribe from `Uniswap V4`, but keep positions accounting intact in Deli gauges.\nThen the malicious user can either burn or resubscribe his position to `PositionManagerAdapter` immediately, diluting the rewards for that range by position `liquidity` forever (even if the admin calls `adminForceUnsubscribe`, `liquidity` remains accounted for in global gauge accounting).\n\n[DailyEpochGauge.sol#L610-L618](https://github.com/sherlock-audit/2025-09-bmx-deli-swap/blob/main/deli-swap-contracts/src/DailyEpochGauge.sol#L610-L618):\n```solidity\n    poolRewards[pid].modifyPositionLiquidity(\n        RangePool.ModifyLiquidityParams({\n            tickLower: tickLower,\n            tickUpper: tickUpper,\n            //@audit when subscribing, current position liquidity is always added to global liquidity tracking\n            liquidityDelta: SafeCast.toInt128(uint256(liquidity)),\n            tickSpacing: poolTickSpacing[pid]\n        }),\n        toks\n    );\n```\n\n### POC\nHere we show that the already existing test case `testGasAdapterNotifyUnsubTwoWorst` can be adapted to show that `notifyUnsubscribe` fails due to OOG.\n\nTo do so, we isolate the \"set up\" of the test case in a separate transaction by using the special function `beforeTestSetup` (see [foundry documentation](https://getfoundry.sh/forge/tests/writing-tests/)).\n\nPlease run:\n1. `git apply POC.patch`\n2. `forge test --match-test testGasAdapterNotifyUnsubTwoWorst -vvvv --decode-internal`\n\n```diff\ndiff --git a/deli-swap-contracts/test/integration/PositionLifecycleCleanup.t.sol b/deli-swap-contracts/test/integration/PositionLifecycleCleanup.t.sol\nindex 07499d3..56ab07e 100644\n--- a/deli-swap-contracts/test/integration/PositionLifecycleCleanup.t.sol\n+++ b/deli-swap-contracts/test/integration/PositionLifecycleCleanup.t.sol\n@@ -594,31 +594,36 @@ contract PositionLifecycleCleanup_IT is Test, Deployers {\n         _gasAdapterNotifyUnsub(3, \"adapter_notify_unsub_3\");\n     }\n \n-    /// Worst-case parameters for unsubscribe gas: two extra incentive tokens (plus base wBLT from _activateStream),\n-    /// large elapsed time without prior syncs to force Daily's multi-day integration and maximize cold reads.\n-    /// to force Daily's multi-day integration during unsubscribe and maximize cold reads.\n-    function testGasAdapterNotifyUnsubTwoWorst() public {\n+    function worstCaseBeforeSetup() public {\n         // 1) Mint and subscribe two positions\n-        uint256 tokenId = _mintAndSubscribe(-1800, 1800, 1e22);\n+        uint256 tokenId = _mintAndSubscribe(-2400, 2400, 1e22);\n+        //@audit-ok enforce first token minted has id == 2 for consistency with test case\n+        assert(tokenId == 2);\n         uint256 tokenId2 = _mintAndSubscribe(-1800, 1800, 1e22);\n \n         // 2) Activate Daily stream and base incentive, then add two extra incentive tokens (3 total incentives)\n         _activateStream();\n-        _addIncentiveTokens(10);\n+        //@audit-ok no need to add additional incentive tokens\n \n-        // 3) Warp many days ahead to force DailyEpochGauge._amountOverWindow to iterate across many day boundaries\n-        //    and ensure significant elapsed time for incentive calculations, without additional pokes.\n-        vm.warp(block.timestamp + 4 days);\n+        //@audit-ok no need to even warp\n+    }\n \n-        // 4) Measure only the adapter.notifyUnsubscribe path\n-        vm.startPrank(address(positionManager));\n-        vm.startSnapshotGas(\"adapter_notify_unsub_2_worst_first\");\n-        adapter.notifyUnsubscribe(tokenId);\n-        vm.stopSnapshotGas();\n-        vm.startSnapshotGas(\"adapter_notify_unsub_2_worst_second\");\n-        adapter.notifyUnsubscribe(tokenId2);\n-        vm.stopSnapshotGas();\n-        vm.stopPrank();\n+    //@audit-ok special foundry function, isolates calls before test in a separate transaction\n+    function beforeTestSetup(bytes4 testSelector) public returns (bytes[] memory beforeTestCalldata) {\n+        if (testSelector == this.testGasAdapterNotifyUnsubTwoWorst.selector) {\n+            beforeTestCalldata = new bytes[](1);\n+            //@audit-ok make the setup for the worst case in an isolated transaction\n+            //@audit-ok we do this to avoid warming up all of the storage slots used later in notifySubscribe call\n+            beforeTestCalldata[0] = abi.encodeWithSelector(this.worstCaseBeforeSetup.selector);\n+        }\n+    }\n+\n+    /// Worst-case parameters for unsubscribe gas: two extra incentive tokens (plus base wBLT from _activateStream),\n+    /// large elapsed time without prior syncs to force Daily's multi-day integration and maximize cold reads.\n+    /// to force Daily's multi-day integration during unsubscribe and maximize cold reads.\n+    function testGasAdapterNotifyUnsubTwoWorst() public {\n+        //@audit-ok use hardcoded token id 2 for simplicity, but this is enforced with assert during preparation\n+        positionManager.unsubscribe(2); // @audit-ok run forge test -vvvv to see that notifyUnsubscribe has failed with OOG\n     }\n \n     /*//////////////////////////////////////////////////////////////\n```\n\n### Recommendation\n\nFurther gas optimisations must be made to `notifyUnsubscribe` not to hit the limit. A radical change could be to only set a flag \"pendingUnsubscribe\" on the given position in both the daily gauge and the incentive gauge, to make it ineligible for claiming at first. Then the heavy work of unsubscribing and cleaning accounting data can be done during a subsequent call outside of the critical path.\n\n",
    "summary": "\nThe bug report discusses a vulnerability found in the Uniswap V4 notifier that allows malicious users to force unsubscribe from Uniswap V4 while keeping their positions intact in Deli gauges. This can lead to dilution of rewards for other users. The report provides a proof of concept and recommends further gas optimizations to prevent this issue.",
    "report_date": "2025-09-16T15:00:00.000Z",
    "contest_prize_txt": "47000 USDC",
    "contest_link": "https://app.sherlock.xyz/audits/contests/1154",
    "sponsor_name": "",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "",
    "github_link": "https://github.com/sherlock-audit/2025-09-bmx-deli-swap-judging/issues/27",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "1154",
    "slug": "h-1-gas-consumed-in-notifyunsubscribe-is-underestimated-during-tests-and-is-greater-than-300000-without-pre-warming-sherlock-bmx-deli-swap-git",
    "firm_name": "Sherlock",
    "firm_logo_square": "sherlock_square.png",
    "protocol_name": "BMX Deli Swap",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "cergyk"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Sherlock",
        "logo_square": "sherlock_square.png"
    },
    "protocols_protocol": {
        "name": "BMX Deli Swap",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}