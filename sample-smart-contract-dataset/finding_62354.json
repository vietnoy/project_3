{
    "id": 62354,
    "kind": "MARKDOWN",
    "auditfirm_id": 34,
    "impact": "HIGH",
    "finders_count": 1,
    "protocol_id": 967,
    "title": "[BAB-3] Stealing ETH using reentrancy in minting pass",
    "content": "**Severity:** Critical\n\n**Path:** BabylonCore.sol:participate (L89-114)\n\n**Description:** In `BabylonCore.sol:participate` a user can buy tickets, which are minting pass NFTs and minted to the user. The minting pass contracts uses `_safeMint`, which makes an external call with `onERC721Received` to the receiver user and thus that execution is passed to the user upon minting. \n\nAs a result, a reentrancy vulnerability exists because there are state changing effects after the call to mint on L102, e.g. the current tickets total on L104 and the listing’s state on L110.\n\nThis vulnerability can be abused to inflate the listing’s current tickets beyond the total tickets and refund/burn tickets without cancelling the listing. The creator could buy and refund a part of the tickets but still gain the full amount of ETH when the listing is finalized, netting a positive amount and thus effectively stealing ETH.\n```\nfunction participate(uint256 id, uint256 tickets) external payable {\n    ListingInfo storage listing =  _listingInfos[id];\n    require(\n        _tokensController.checkApproval(listing.creator, listing.item),\n        \"BabylonCore: Token is no longer owned or approved to the controller\"\n    );\n    require(listing.state == ListingState.Active, \"BabylonCore: Listing state should be active\");\n    require(block.timestamp >= listing.timeStart, \"BabylonCore: Too early to participate\");\n    uint256 current = listing.currentTickets;\n    require(current + tickets <= listing.totalTickets, \"BabylonCore: no available tickets\");\n    uint256 totalPrice = listing.price * tickets;\n    require(msg.value == totalPrice, \"BabylonCore: msg.value doesn't match price for tickets\");\n\n    IBabylonMintPass(listing.mintPass).mint(msg.sender, tickets);\n\n    listing.currentTickets = current + tickets;\n\n    emit NewParticipant(id, msg.sender, tickets);\n\n    if (listing.currentTickets == listing.totalTickets) {\n        listing.randomRequestId = _randomProvider.requestRandom(id);\n        listing.state = ListingState.Resolving;\n\n        emit ListingResolving(id, listing.randomRequestId);\n    }\n}\n```\n\n**Remediation:**  The call to `mint` should be done at the end of the function or a reentrancy guard should be added to the function.\n\n**Status:**  Fixed\n\n\n- - -",
    "summary": "\nThe report describes a critical bug in the BabylonCore smart contract, specifically in the `participate` function. This function allows users to buy tickets, which are NFTs that are minted and given to the user. However, there is a vulnerability that allows for reentrancy, meaning that the function can be called multiple times before it finishes executing. This can be exploited to inflate the number of tickets and steal ETH from the contract. The bug has been fixed by moving the `mint` function to the end of the `participate` function or by adding a reentrancy guard.",
    "report_date": "2023-01-17T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/solodit/solodit_content/blob/main/reports/Hexens/2023-01-17-Babylon.md",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "bab-3-stealing-eth-using-reentrancy-in-minting-pass-hexens-none-babylon-markdown",
    "firm_name": "Hexens",
    "firm_logo_square": "Hexens_square.png",
    "protocol_name": "Babylon",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Hexens"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Hexens",
        "logo_square": "Hexens_square.png"
    },
    "protocols_protocol": {
        "name": "Babylon",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}