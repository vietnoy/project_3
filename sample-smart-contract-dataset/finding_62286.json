{
    "id": 62286,
    "kind": "PDF",
    "auditfirm_id": 6,
    "impact": "MEDIUM",
    "finders_count": 3,
    "protocol_id": 3396,
    "title": "WETH9 market cannot be deployed due to flawed _determineIfAToken logic",
    "content": "## Severity: Medium Risk\n\n## Context\n`ATokenERC6909.sol#L440-L446`\n\n## Description\nWhen deploying a minipool, underlying tokens are checked to see if they are aTokens from the main lending pool.\n\n### Code Snippet\n```solidity\nfunction _determineIfAToken(address underlying, address MLP) internal view returns (bool) {\n    try IAToken(underlying).getPool() returns (address pool) {\n        return pool == MLP;\n    } catch {\n        return false;\n    }\n}\n```\n\nHowever, this logic is flawed for tokens that have a fallback function such as WETH9. The `try/catch` clause is intended to handle the revert in cases where the function `getPool` does not exist on the token. But in the case of WETH9, the fallback function is executed, which attempts a deposit. As a result, an EVM error (attempt to write to storage during staticcall) is thrown instead of a revert, consuming all of the remaining gas in the context.\n\nNote that in Oracle, limiting gas passed is used as a workaround for this:\n```solidity\n// Check if `asset` is an aToken.\ntry ATokenNonRebasing(asset).UNDERLYING_ASSET_ADDRESS{gas: 4000}() returns (address underlying_) {\n    underlying = underlying_;\n} catch {\n    underlying = asset;\n}\n```\n\nWhile this solution works, it is not robust. For example, if aToken logic is upgraded and requires more than 4000 gas to obtain the underlying asset, it will fail.\n\n## Impact\nWhen attempting to deploy minipools that have WETH9 as the underlying asset, the call will always revert due to running out of gas. Please note that due to EIP-150, only 63/64 of gas is passed on to the `IAToken(underlying).getPool()`, so the call can technically succeed by wasting an enormous amount of gas.\n\n## Recommendation\nUse a low-level call (as opposed to the static call generated by Solidity for using a view function) to get the pool value. This way, if the WETH9 fallback function is invoked, the function would succeed but would not yield a uint value, and it would be correctly treated as a non-aToken.\n\n## Astera\nFixed `_determineIfAToken` in commits `a0b5ca43` and `208aa500`. Fixed oracle in commits `899875bc` and `c37de4d0`.\n\n## Spearbit\nFix verified.",
    "summary": "\nThis bug report discusses a problem with the code for deploying a minipool. The code checks if the underlying tokens are aTokens from the main lending pool, but it has a flaw that causes an error when using tokens with a fallback function, such as WETH9. This error consumes all remaining gas, causing the call to revert. A workaround is suggested, but it is not robust and may fail in certain situations. The recommended solution is to use a low-level call instead of a static call to avoid this issue. The bug has been fixed in the Astera and Spearbit commits. ",
    "report_date": "2025-08-29T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Astera-Spearbit-Security-Review-December-2024.pdf",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/spearbit/portfolio/blob/master/pdfs/Astera-Spearbit-Security-Review-December-2024.pdf",
    "github_link": "",
    "pdf_link": "https://solodit-bucket.s3.amazonaws.com/storage/reports/spearbit/Astera-Spearbit-Security-Review-December-2024.pdf",
    "pdf_page_from": 20,
    "contest_id": "",
    "slug": "weth9-market-cannot-be-deployed-due-to-flawed-_determineifatoken-logic-spearbit-none-astera-pdf",
    "firm_name": "Spearbit",
    "firm_logo_square": "spearbit_square.png",
    "protocol_name": "Astera",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Saw-mon and Natalie"
            }
        },
        {
            "wardens_warden": {
                "handle": "Cergyk"
            }
        },
        {
            "wardens_warden": {
                "handle": "Jonatas Martins"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Spearbit",
        "logo_square": "spearbit_square.png"
    },
    "protocols_protocol": {
        "name": "Astera",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}