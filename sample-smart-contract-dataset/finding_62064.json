{
    "id": 62064,
    "kind": "GIT",
    "auditfirm_id": 2,
    "impact": "MEDIUM",
    "finders_count": 7,
    "protocol_id": 2159,
    "title": "[M-01] Flash loans allow borrowing from frozen pools, bypassing security controls",
    "content": "\n\n<https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/submit.rs# L868-L895>\n\n### Finding description and impact\n\nChanging a pool’s status is crucial for risk management in Blend’s lending protocol, serving as an automatic circuit breaker that responds to changing risk conditions. The three states (Active, On Ice, Frozen) are triggered based on backstop depositors’ withdrawal behavior, as these depositors provide first-loss capital and are most sensitive to risk. When withdrawal queues reach certain thresholds, the protocol restricts operations accordingly, preventing further risk accumulation during uncertain market conditions or when the pool’s health is deteriorating. Pool owners can also manually put the pool on-ice or even frozen it to respond to risks they observe, ensuring the protocol remains resilient against any issues.\n\nThe rules for these changes are outlined in the functions:\n\n* `execute_set_pool_status()`, [here](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/status.rs# L71).\n* `execute_update_pool_status()`, [here](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/status.rs# L11).\n\nThe pool status is checked before processing any operation in the pool, this can be observed in the `build_actions_from_request()` function, [here](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/actions.rs# L130). The validation happens in the `pool.rs` file under the `require_action_allowed()` [function](https://github.com/code-423n4/2025-02-blend/blob/f23b3260763488f365ef6a95bfb139c95b0ed0f9/blend-contracts-v2/pool/src/pool/pool.rs# L75C5-L82C6):\n```\n\npub fn require_action_allowed(&self, e: &Env, action_type: u32) {\n        // disable borrowing or auction cancellation for any non-active pool and disable supplying for any frozen pool\n        if (self.config.status > 1 && (action_type == 4 || action_type == 9))\n            || (self.config.status > 3 && (action_type == 2 || action_type == 0))\n        {\n            panic_with_error!(e, PoolError::InvalidPoolStatus);\n        }\n    }\n```\n\nIf the pool is the frozen or even on-ice state, the protocol should panic.\n\nHowever, there’s a critical security vulnerability in the flash loan implementation. In the way the flash loans are implemented, a user is not obligated to return the borrowed assets, instead the user can keep the funds as a borrow as long as they have a healthy position after the flash loan. In this way, the flash loans can be used to make a simple borrow operation.\n\nThe issue arises because the flash loan implementation do not implement the pool and reserve status validations that are present in the normal borrowing flow in fuctions like `build_actions_from_request()` and `apply_borrow()` with the `pool.require_action_allowed()` and `reserve.require_action_allowed()` checks respectively.\n\n### Proof of concept\n\n1. Admin freezes the pool by setting the pool status to indicate it’s frozen\n\n   * The pool can get frozen permissionless also if the backstop withdrawals reach a certain threshold.\n2. Normal borrowing attempts are rejected due to the validation check in `build_actions_from_request()`.\n3. However, an attacker can still borrow assets by using the flash loan functionality.\n\nFollow the next steps to reproduce the issue in a coded test:\n\nIn the `test-suites/tests/test_flash_loan.rs` file, paste the following test:\n```\n\n#[test]\nfn test_flashloan_bypass_frozen_pool() {\n    let fixture = create_fixture_with_data(true);\n    let pool_fixture = &fixture.pools[0];\n    let frodo = fixture.users[0].clone();\n\n    let xlm = &fixture.tokens[TokenIndex::XLM];\n    let xlm_address = xlm.address.clone();\n    let stable = &fixture.tokens[TokenIndex::STABLE];\n    let stable_address = stable.address.clone();\n\n    let (receiver_address, _) = create_flashloan_receiver(&fixture.env);\n\n    let samwise = Address::generate(&fixture.env);\n\n    let approval_ledger = fixture.env.ledger().sequence() + 17280;\n\n    xlm.mint(&samwise, &(100 * SCALAR_7));\n    xlm.approve(\n        &samwise,\n        &pool_fixture.pool.address,\n        &i128::MAX,\n        &approval_ledger,\n    );\n    stable.mint(&samwise, &(100 * SCALAR_7));\n    stable.approve(\n        &samwise,\n        &pool_fixture.pool.address,\n        &i128::MAX,\n        &approval_ledger,\n    );\n\n    let supply_collateral_request: Vec<Request> = vec![\n        &fixture.env,\n        Request {\n            request_type: RequestType::SupplyCollateral as u32,\n            address: stable_address.clone(),\n            amount: 50 * SCALAR_7,\n        },\n    ];\n\n    pool_fixture.pool.submit(&samwise, &samwise, &samwise, &supply_collateral_request);\n\n    let flash_loan = FlashLoan {\n        contract: receiver_address.clone(),\n        asset: xlm_address.clone(),\n        amount: 1_000 * SCALAR_7,\n    };\n\n    // No requests.\n    let actions_request: Vec<Request> = vec![\n        &fixture.env,\n    ];\n\n    // Pool is frozen.\n    pool_fixture.pool.set_status(&4);\n    let pool_status = pool_fixture.pool.get_config();\n    assert_eq!(pool_status.status, 4);\n\n    // However flash loan will go through.\n    pool_fixture\n        .pool\n        .flash_loan(&samwise, &flash_loan, &actions_request);\n}\n```\n\nRun the test with `cargo test --test test_flashloan -- --nocapture -- test_flashloan_bypass_frozen_pool`.\n\n### Recommended mitigation steps\n\nAdd the validations `pool.require_action_allowed()` and `reserve.require_action_allowed()` in the flash loan implementation.\n\n**markus\\_pl10 (Script3) confirmed**\n\n**[Blend mitigated](https://github.com/code-423n4/2025-04-blend-mitigation?tab=readme-ov-file# mitigation-of-high--medium-severity-issues):**\n\n> [Commit e4ed914](https://github.com/blend-capital/blend-contracts-v2/commit/e4ed914e45433f160bb4f066fd517667b7d8907b) to clean up flash loans implementation.\n\n**Status:** Initial fix resolved the issue described in [Testerbot’s submission S-276](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/S-276), but did not resolve the issue described in duplicate submission [S-308 by peakbolt](https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/S-308). Please refer to the [Mitigation Review](# m-01-unmitigated) section of this report for additional details.\n\n---\n\n",
    "summary": "\nThe report discusses a bug in Blend's lending protocol that allows users to bypass the protocol's risk management measures and borrow assets even when the pool is frozen. This is due to a vulnerability in the flash loan implementation, which does not include the necessary status checks. The report recommends adding these checks to the flash loan implementation to mitigate the issue. Blend has already implemented a fix to address this issue, but it may not fully resolve the problem. ",
    "report_date": "2025-08-13T00:00:00.000Z",
    "contest_prize_txt": "125000",
    "contest_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "sponsor_name": "Blend",
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://code4rena.com/reports/2025-02-blend-v2-audit-certora-formal-verification",
    "github_link": "https://code4rena.com/audits/2025-02-blend-v2-audit-certora-formal-verification/submissions/F-5",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "492",
    "slug": "m-01-flash-loans-allow-borrowing-from-frozen-pools-bypassing-security-controls-code4rena-blend-blend-git",
    "firm_name": "Code4rena",
    "firm_logo_square": "code4rena_square.png",
    "protocol_name": "Blend",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "carrotsmuggler"
            }
        },
        {
            "wardens_warden": {
                "handle": "oakcobalt"
            }
        },
        {
            "wardens_warden": {
                "handle": "peakbolt"
            }
        },
        {
            "wardens_warden": {
                "handle": "Testerbot"
            }
        },
        {
            "wardens_warden": {
                "handle": "aldarion"
            }
        },
        {
            "wardens_warden": {
                "handle": "0x007"
            }
        },
        {
            "wardens_warden": {
                "handle": "YouCrossTheLineAlfie"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Code4rena",
        "logo_square": "code4rena_square.png"
    },
    "protocols_protocol": {
        "name": "Blend",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}