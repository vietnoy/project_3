{
    "id": 62852,
    "kind": "MARKDOWN",
    "auditfirm_id": 30,
    "impact": "MEDIUM",
    "finders_count": 1,
    "protocol_id": 3449,
    "title": "[M-02] Solver Can Receive Zero Settlement When Fee Exceeds Token Amount",
    "content": "\n## Severity\n\nMedium Risk\n\n## Description\n\nThe `settleInvoice()` function finalizes invoice settlement by calling `_processTokenTransfers()`, which deducts protocol fees and sends the remaining balance to the solver. Inside `_processTokenTransfers()`, the fee is calculated with `_calculateFeeForToken()`. If the fee exceeds the token amount, the function sets `pulseFee = amount`, leaving the solver with `solverAmount = 0`.\n\nThis situation results in the entire token payment being sent to the fee receiver, while the solver receives nothing, even though the solver successfully completed the work. The vulnerability arises because no validation exists during invoice creation to ensure that the token amount is always greater than the expected protocol fee.\n\n## Location of Affected Code\n\nFile: [InvoiceManager.sol](https://github.com/etherspot/etherspot-modular-accounts/blob/9019f2a78c36e74bdb1df4029672998cb4631162/src/invoice_manager/InvoiceManager.sol#L605)\n\n```solidity\nfunction _processTokenTransfers( address _sessionKey, address solver, InvoiceTokenData[] storage tokens, uint256 tokensLength, uint256 invoicePulseFee ) internal {\n  // code\n  uint256 pulseFee = _calculateFeeForToken(token, invoicePulseFee);\n  if (pulseFee > amount) {\n      pulseFee = amount; // entire amount sent as fee\n  }\n  uint256 solverAmount = amount - pulseFee;\n  // code\n}\n```\n\n## Impact\n\nIf an invoice is created with a very small token amount, or if fees are later set higher than the amount, solvers receive zero settlement.\n\n## Proof of Concept\n\n1. Create an invoice with `amount = 1` token unit.\n2. If `_calculateFeeForToken()` returns `5` units as the minimum fee, the contract enforces `pulseFee = 1`.\n3. Result: Solver receives `0`, fee receiver receives `1`.\n\n## Recommendation\n\nIntroduce a minimum amount validation at invoice creation to guarantee that `amount > expected fee`, ensuring solvers are never left unpaid.\n\n## Team Response\n\nFixed.\n\n",
    "summary": "\nThis bug report describes a problem in a function called `settleInvoice()` which is used to finalize payments on an invoice. The problem occurs when the function calls another function called `_processTokenTransfers()`, which calculates fees and sends the remaining balance to the person who completed the work. However, if the fee is larger than the token amount, the function sets the fee to be equal to the token amount, leaving the person who completed the work with no payment. This happens because there is no check in place to make sure that the token amount is always greater than the expected fee. This bug can result in the person who completed the work receiving no payment, even though they did the work correctly. The affected code can be found in the InvoiceManager.sol file. To demonstrate this bug, you can create an invoice with a small token amount and the solver will receive no payment. The recommendation is to add a check to make sure that the token amount is always greater than the expected fee. The team has fixed the bug.",
    "report_date": "2025-10-03T00:00:00.000Z",
    "contest_prize_txt": "",
    "contest_link": "",
    "sponsor_name": null,
    "sponsor_link": "",
    "quality_score": 0,
    "general_score": 0,
    "source_link": "https://github.com/shieldify-security/audits-portfolio-md/blob/main/Etherspot-GasTankPaymasterModule-Extended-Security-Review.md",
    "github_link": "",
    "pdf_link": "",
    "pdf_page_from": 0,
    "contest_id": "",
    "slug": "m-02-solver-can-receive-zero-settlement-when-fee-exceeds-token-amount-shieldify-none-etherspot-gastankpaymastermodule-extended-markdown",
    "firm_name": "Shieldify",
    "firm_logo_square": "Shieldify_square.png",
    "protocol_name": "Etherspot Gastankpaymastermodule Extended",
    "bookmarked": false,
    "read": false,
    "issues_issue_finders": [
        {
            "wardens_warden": {
                "handle": "Shieldify Security"
            }
        }
    ],
    "auditfirms_auditfirm": {
        "name": "Shieldify",
        "logo_square": "Shieldify_square.png"
    },
    "protocols_protocol": {
        "name": "Etherspot Gastankpaymastermodule Extended",
        "protocols_protocolcategoryscore": []
    },
    "issues_issuetagscore": []
}